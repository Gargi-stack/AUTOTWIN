import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
import plotly.express as px
from datetime import datetime
import time
import os

# â”€â”€ Import Thevenin ECM backend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
from thevenin_ecm import TheveninECM, NASA_Q_NOMINAL
from lumped_thermal import LumpedThermalModel

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PAGE CONFIG
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
st.set_page_config(
    page_title="AUTOTWIN - Battery Digital Twin",
    page_icon="âš¡",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CSS  (original AUTOTWIN styling â€” preserved exactly)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
st.markdown("""
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;800;900&family=Exo+2:wght@300;400;600;700;800&family=Share+Tech+Mono&display=swap');
:root {
  --cyan: #00c8ff; --cyan-dim: #0099cc; --pink: #ff00c8; --pink-dim: #cc0099;
  --green: #00ff88; --green-dim: #00cc66; --gold: #ffd700;
  --bg-base: #f0f9ff; --bg-panel: rgba(255,255,255,0.88);
  --bg-glass: rgba(240,252,255,0.70); --border: rgba(0,200,255,0.35);
  --text-main: #0a1628; --text-dim: #2a4060; --text-muted:#5a7090;
  --glow-cyan: 0 0 8px #00c8ff, 0 0 20px rgba(0,200,255,0.5), 0 0 40px rgba(0,200,255,0.2);
  --glow-pink: 0 0 8px #ff00c8, 0 0 20px rgba(255,0,200,0.5), 0 0 40px rgba(255,0,200,0.2);
  --glow-green:0 0 8px #00ff88, 0 0 20px rgba(0,255,136,0.5), 0 0 40px rgba(0,255,136,0.2);
}
.stApp {
  background-color: var(--bg-base) !important;
  background-image:
    linear-gradient(rgba(0,200,255,0.07) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,200,255,0.07) 1px, transparent 1px),
    linear-gradient(rgba(0,200,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,200,255,0.03) 1px, transparent 1px),
    radial-gradient(ellipse 80% 50% at 20% 10%, rgba(0,200,255,0.12) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 80%, rgba(255,0,200,0.08) 0%, transparent 60%);
  background-size: 40px 40px, 40px 40px, 8px 8px, 8px 8px, 100% 100%, 100% 100%;
  font-family: 'Exo 2', sans-serif !important;
}
.stApp::after {
  content: ''; position: fixed; inset: 0;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,200,255,0.015) 2px, rgba(0,200,255,0.015) 4px);
  pointer-events: none; z-index: 9999;
}
html, body, [class*="css"] { font-family: 'Exo 2', sans-serif !important; }
.cyber-header {
  position: relative;
  background: linear-gradient(135deg, rgba(255,255,255,0.97) 0%, rgba(224,248,255,0.95) 50%, rgba(255,255,255,0.97) 100%);
  border: 2px solid var(--cyan); border-radius: 20px;
  padding: 2.5rem 2rem 2rem; margin-bottom: 2rem; overflow: hidden;
  box-shadow: 0 0 0 1px rgba(0,200,255,0.15), 0 8px 40px rgba(0,200,255,0.2), inset 0 1px 0 rgba(255,255,255,1);
}
.cyber-header::before, .cyber-header::after {
  content: ''; position: absolute; width: 40px; height: 40px;
  border-color: var(--cyan); border-style: solid;
}
.cyber-header::before { top: 12px; left: 12px; border-width: 3px 0 0 3px; box-shadow: -3px -3px 12px rgba(0,200,255,0.4); }
.cyber-header::after  { bottom: 12px; right: 12px; border-width: 0 3px 3px 0; box-shadow: 3px 3px 12px rgba(0,200,255,0.4); }
.header-beam { position: absolute; top: 0; left: -100%; width: 60%; height: 3px;
  background: linear-gradient(90deg, transparent, var(--cyan), var(--pink), transparent);
  animation: beam-sweep 4s ease-in-out infinite; }
@keyframes beam-sweep { 0% { left: -60%; } 100% { left: 160%; } }
.cyber-title {
  font-family: 'Orbitron', monospace !important; font-size: 4.2rem; font-weight: 900;
  letter-spacing: 0.35em; text-align: center;
  background: linear-gradient(90deg, #005fa3, #00c8ff, #ff00c8, #00c8ff, #005fa3);
  background-size: 300% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text; animation: title-shift 6s linear infinite;
  filter: drop-shadow(0 0 18px rgba(0,200,255,0.45)); margin: 0;
}
@keyframes title-shift { 0% { background-position: 0% 50%; } 100% { background-position: 300% 50%; } }
.cyber-subtitle {
  font-family: 'Share Tech Mono', monospace; text-align: center; font-size: 1rem;
  letter-spacing: 0.25em; color: var(--cyan-dim); margin-top: 0.6rem;
  animation: sub-flicker 5s ease-in-out infinite;
}
@keyframes sub-flicker { 0%,100% { opacity:1; } 92% { opacity:1; } 93% { opacity:0.4; } 94% { opacity:1; } }
.header-stats-bar { display: flex; justify-content: center; gap: 2rem; margin-top: 1.4rem; flex-wrap: wrap; }
.hstat { font-family: 'Share Tech Mono', monospace; font-size: 0.78rem; letter-spacing: 0.1em;
  color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
.hstat-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green);
  box-shadow: var(--glow-green); animation: pulse-dot 2s ease-in-out infinite; }
@keyframes pulse-dot { 0%,100%{ transform:scale(1); opacity:1; } 50% { transform:scale(1.5); opacity:0.7; } }
.stTabs [data-baseweb="tab-list"] {
  gap: 8px;
  background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(224,248,255,0.90));
  border: 2px solid var(--border); border-radius: 18px; padding: 14px 16px; margin-bottom: 28px;
  box-shadow: 0 4px 30px rgba(0,200,255,0.12), inset 0 1px 0 rgba(255,255,255,1);
  justify-content: center !important; display: flex !important; flex-wrap: wrap !important;
}
.stTabs [data-baseweb="tab"] {
  height: 58px; background: rgba(240,252,255,0.70); border: 2px solid rgba(0,200,255,0.25);
  border-radius: 12px; color: var(--text-dim); font-family: 'Orbitron', monospace !important;
  font-size: 0.65rem; font-weight: 700; letter-spacing: 0.1em; padding: 0 18px;
  transition: all 0.35s cubic-bezier(0.4,0,0.2,1); position: relative; overflow: hidden; flex-shrink: 0;
}
.stTabs [data-baseweb="tab"]::before {
  content: ''; position: absolute; bottom: 0; left: -100%; width: 100%; height: 2px;
  background: linear-gradient(90deg, var(--cyan), var(--pink)); transition: left 0.4s;
}
.stTabs [data-baseweb="tab"]:hover::before { left: 0; }
.stTabs [data-baseweb="tab"]:hover {
  border-color: rgba(0,200,255,0.6); color: var(--cyan-dim); transform: translateY(-3px);
  background: rgba(224,248,255,0.9);
  box-shadow: 0 6px 20px rgba(0,200,255,0.2), 0 0 0 1px rgba(0,200,255,0.15);
}
.stTabs [aria-selected="true"] {
  background: linear-gradient(135deg, #00c8ff 0%, #0080cc 50%, #ff00c8 100%) !important;
  border-color: var(--cyan) !important; color: white !important; transform: translateY(-5px) !important;
  box-shadow: 0 10px 30px rgba(0,200,255,0.4), 0 0 25px rgba(0,200,255,0.25), inset 0 1px 0 rgba(255,255,255,0.4) !important;
  font-family: 'Orbitron', monospace !important; font-size: 0.65rem !important; font-weight: 900 !important;
  letter-spacing: 0.12em !important; animation: tab-active-pulse 3s ease-in-out infinite;
}
@keyframes tab-active-pulse {
  0%,100%{ box-shadow: 0 10px 30px rgba(0,200,255,0.4), 0 0 25px rgba(0,200,255,0.25); }
  50% { box-shadow: 0 12px 36px rgba(0,200,255,0.5), 0 0 35px rgba(0,200,255,0.35); }
}
.stTabs [data-baseweb="tab-highlight"] { display: none !important; }
.tab-header {
  position: relative;
  background: linear-gradient(135deg, rgba(255,255,255,0.97), rgba(224,248,255,0.88));
  border: 2px solid var(--border); border-left: 5px solid var(--cyan); border-radius: 16px;
  padding: 22px 30px; margin-bottom: 28px; display: flex; align-items: center; gap: 18px;
  box-shadow: 0 4px 24px rgba(0,200,255,0.12), inset 0 1px 0 rgba(255,255,255,1); overflow: hidden;
}
.tab-header::after {
  content: ''; position: absolute; top: 0; right: 0; width: 200px; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(0,200,255,0.06)); pointer-events: none;
}
.tab-header-icon { font-size: 2.6rem; filter: drop-shadow(0 0 8px rgba(0,200,255,0.5)); animation: icon-bob 3s ease-in-out infinite; }
@keyframes icon-bob { 0%,100%{ transform: translateY(0); } 50% { transform: translateY(-6px); } }
.tab-header-title { font-family: 'Orbitron', monospace !important; font-size: 1.9rem; font-weight: 800;
  color: var(--text-main); margin: 0; letter-spacing: 0.05em; text-shadow: 0 0 20px rgba(0,200,255,0.3); }
.tab-header-subtitle { font-family: 'Share Tech Mono', monospace; font-size: 0.85rem; color: var(--text-muted); margin: 4px 0 0; letter-spacing: 0.1em; }
.metric-card {
  position: relative;
  background: linear-gradient(145deg, rgba(255,255,255,0.98), rgba(232,248,255,0.92));
  border: 2px solid rgba(0,200,255,0.35); border-radius: 20px; padding: 2.5rem 1.8rem;
  text-align: center; overflow: hidden;
  transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
  box-shadow: 0 8px 32px rgba(0,0,0,0.08), 0 0 0 1px rgba(0,200,255,0.1), inset 0 1px 0 rgba(255,255,255,1);
  transform-style: preserve-3d; cursor: default;
}
.metric-card::before { content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 3px; background: linear-gradient(90deg, var(--cyan), transparent); }
.metric-card::after  { content: ''; position: absolute; bottom: 0; right: 0; width: 50%; height: 3px; background: linear-gradient(270deg, var(--cyan), transparent); }
.metric-card:hover {
  transform: perspective(800px) rotateX(-4deg) translateY(-10px) scale(1.03);
  box-shadow: 0 24px 60px rgba(0,200,255,0.22), 0 0 40px rgba(0,200,255,0.15), 0 0 0 2px var(--cyan);
}
.metric-label { font-family: 'Orbitron', monospace; font-size: 0.72rem; font-weight: 700; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.8rem; }
.metric-value { font-family: 'Orbitron', monospace; font-size: 3.8rem; font-weight: 900; color: var(--text-main); margin: 0.4rem 0; line-height: 1; text-shadow: 0 0 20px rgba(0,200,255,0.4); }
.metric-unit  { font-family: 'Share Tech Mono', monospace; font-size: 1rem; color: var(--text-muted); letter-spacing: 0.1em; }
.metric-badge { position: absolute; top: 14px; right: 14px; font-family: 'Share Tech Mono', monospace; font-size: 0.65rem; letter-spacing: 0.08em; padding: 3px 8px; border-radius: 6px; border: 1px solid; }
.model-card {
  position: relative; background: linear-gradient(145deg, rgba(255,255,255,0.97), rgba(232,248,255,0.90));
  border: 2px solid rgba(0,200,255,0.3); border-radius: 22px; padding: 2.2rem 1.8rem;
  text-align: center; cursor: pointer; transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
  min-height: 380px; display: flex; flex-direction: column; justify-content: space-between;
  overflow: hidden; transform-style: preserve-3d;
  box-shadow: 0 6px 28px rgba(0,0,0,0.07), 0 0 0 1px rgba(0,200,255,0.08);
}
.model-card-active {
  background: linear-gradient(135deg, #003d5c 0%, #00527a 40%, #006095 100%) !important;
  border: 3px solid var(--cyan) !important; transform: perspective(900px) rotateY(-3deg) translateY(-12px) scale(1.04) !important;
  box-shadow: 0 30px 70px rgba(0,200,255,0.4), 0 0 60px rgba(0,200,255,0.25), inset 0 1px 0 rgba(255,255,255,0.2) !important;
  animation: active-card-glow 3s ease-in-out infinite; min-height: 380px !important;
}
@keyframes active-card-glow {
  0%,100%{ box-shadow: 0 30px 70px rgba(0,200,255,0.4), 0 0 60px rgba(0,200,255,0.25); }
  50% { box-shadow: 0 30px 80px rgba(0,200,255,0.55), 0 0 80px rgba(0,200,255,0.35); }
}
.stButton > button {
  font-family: 'Orbitron', monospace !important; font-size: 0.82rem !important; font-weight: 700 !important;
  letter-spacing: 0.15em !important;
  background: linear-gradient(135deg, #00527a, #00c8ff 60%, #0066aa) !important; background-size: 200% auto !important;
  color: white !important; border: 2px solid rgba(0,200,255,0.6) !important; border-radius: 12px !important;
  padding: 18px 40px !important; width: 100%;
  transition: all 0.4s cubic-bezier(0.4,0,0.2,1) !important; position: relative; overflow: hidden;
  box-shadow: 0 6px 28px rgba(0,200,255,0.3), 0 0 0 1px rgba(0,200,255,0.2), inset 0 1px 0 rgba(255,255,255,0.35) !important;
}
.stButton > button:hover {
  transform: translateY(-4px) !important; background-position: right center !important;
  box-shadow: 0 14px 40px rgba(0,200,255,0.4), 0 0 40px rgba(0,200,255,0.25), inset 0 1px 0 rgba(255,255,255,0.4) !important;
  border-color: var(--cyan) !important;
}
.section-divider {
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--cyan) 20%, var(--pink) 50%, var(--cyan) 80%, transparent);
  margin: 36px 0; border-radius: 2px; box-shadow: 0 0 12px rgba(0,200,255,0.4);
  animation: divider-pulse 4s ease-in-out infinite;
}
@keyframes divider-pulse { 0%,100%{ opacity:0.7; } 50% { opacity:1; } }
.glass-panel {
  background: linear-gradient(145deg, rgba(255,255,255,0.97), rgba(232,248,255,0.90));
  border: 2px solid rgba(0,200,255,0.3); border-radius: 18px; padding: 28px; margin-bottom: 24px;
  box-shadow: 0 6px 28px rgba(0,200,255,0.1), inset 0 1px 0 rgba(255,255,255,1);
  position: relative; overflow: hidden;
}
.glass-panel::before {
  content:''; position:absolute; top:0;left:0;right:0;height:3px;
  background: linear-gradient(90deg, var(--cyan), var(--pink), var(--cyan));
  background-size: 200% auto; animation: panel-top-beam 4s linear infinite;
}
@keyframes panel-top-beam { 0% { background-position: 0% 50%; } 100%{ background-position: 200% 50%; } }
.glass-panel h3, .glass-panel h4 { font-family: 'Orbitron', monospace !important; color: var(--text-main); letter-spacing: 0.05em; margin-top: 0; }
.output-card {
  position: relative; border-radius: 18px; padding: 28px 20px; text-align: center; min-height: 220px;
  display: flex; flex-direction: column; justify-content: center;
  transition: all 0.35s cubic-bezier(0.4,0,0.2,1); overflow: hidden; transform-style: preserve-3d;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}
.output-card:hover { transform: perspective(700px) rotateX(-5deg) translateY(-8px); box-shadow: 0 20px 50px rgba(0,0,0,0.15); }
.output-icon { font-size: 2.8rem; margin-bottom: 10px; }
.output-label { font-family: 'Orbitron', monospace; font-size: 0.7rem; letter-spacing: 0.2em; text-transform: uppercase; margin-bottom: 10px; opacity: 0.9; }
.output-value { font-family: 'Orbitron', monospace; font-size: 3.2rem; font-weight: 900; line-height: 1; margin-bottom: 6px; }
.output-unit  { font-family: 'Share Tech Mono', monospace; font-size: 0.9rem; opacity: 0.8; letter-spacing: 0.1em; }
.stProgress > div > div { background: linear-gradient(90deg, var(--cyan), var(--pink)) !important; box-shadow: 0 0 12px rgba(0,200,255,0.5) !important; border-radius: 8px !important; }
.stProgress > div { background: rgba(0,200,255,0.1) !important; border-radius: 8px !important; border: 1px solid rgba(0,200,255,0.2) !important; }
.param-box { border-radius: 16px; padding: 26px 28px; margin-bottom: 12px; position: relative; overflow: hidden; box-shadow: 0 6px 24px rgba(0,0,0,0.08); }
.param-title { font-family: 'Orbitron', monospace; font-weight: 700; font-size: 1.05rem; letter-spacing: 0.05em; margin-bottom: 4px; }
.param-desc  { font-family: 'Share Tech Mono', monospace; font-size: 0.78rem; letter-spacing: 0.06em; opacity: 0.7; }
.param-value-badge { background: rgba(255,255,255,0.95); padding: 12px 22px; border-radius: 12px; border: 2px solid; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
.param-val   { font-family: 'Orbitron', monospace; font-weight: 900; font-size: 2.2rem; line-height: 1; }
.param-unit  { font-family: 'Share Tech Mono', monospace; font-size: 1rem; margin-left: 3px; }
.perf-bar-track { background: rgba(0,200,255,0.1); height: 10px; border-radius: 10px; overflow: hidden; border: 1px solid rgba(0,200,255,0.2); }
.perf-bar-fill  { height: 100%; border-radius: 10px; transition: width 0.6s ease; position: relative; overflow: hidden; }
.cyber-footer { background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(224,248,255,0.88)); border: 2px solid rgba(0,200,255,0.25); border-radius: 16px; padding: 24px; text-align: center; margin-top: 20px; }
.footer-text { font-family: 'Share Tech Mono', monospace; font-size: 0.82rem; letter-spacing: 0.2em; color: var(--text-muted); }
.footer-dot  { color: var(--cyan); text-shadow: 0 0 8px var(--cyan); margin: 0 8px; }
.compare-model-card { position: relative; border-radius: 22px; padding: 36px 32px; min-height: 340px; overflow: hidden; transition: all 0.4s cubic-bezier(0.4,0,0.2,1); transform-style: preserve-3d; }
.compare-model-card:hover { transform: perspective(900px) rotateY(-4deg) translateY(-8px); }
#MainMenu { visibility: hidden; } footer { visibility: hidden; } header { visibility: hidden; }
.stDownloadButton > button { font-family: 'Orbitron', monospace !important; font-size: 0.82rem !important; letter-spacing: 0.12em !important; background: linear-gradient(135deg, #003d5c, #00527a, #006095) !important; color: white !important; border: 2px solid var(--cyan) !important; border-radius: 12px !important; box-shadow: 0 6px 28px rgba(0,200,255,0.25) !important; }
.stDownloadButton > button:hover { transform: translateY(-4px) !important; box-shadow: 0 12px 40px rgba(0,200,255,0.4) !important; }
.ecm-result-card {
  background: linear-gradient(145deg, rgba(0,30,60,0.97), rgba(0,60,100,0.95));
  border: 2px solid var(--cyan); border-radius: 18px; padding: 24px 20px; text-align: center;
  box-shadow: 0 8px 32px rgba(0,200,255,0.35), 0 0 0 1px rgba(0,200,255,0.2);
}
.ecm-param-row {
  background: rgba(255,255,255,0.97); border: 2px solid rgba(0,200,255,0.35);
  border-radius: 14px; padding: 16px 20px; margin-bottom: 12px;
  display: flex; justify-content: space-between; align-items: center;
}
</style>
""", unsafe_allow_html=True)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SESSION STATE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
defaults = {
    "selected_model": "ECM",
    "is_simulating": False,
    "simulation_progress": 0,
    "soc": 85,
    "temperature": 25,
    "current": 2.5,
    "ecm_results": None,        # Stores single/last ECM run output dict (used by other tabs)
    "ecm_filename": None,       # Name of last processed file
    "ecm_qnom": NASA_Q_NOMINAL,
    "ecm_batch_results": [],    # List of dicts, one per uploaded file â€” for batch/compare view
    "ecm_results_folder": "",   # Last used results folder path for auto-load
    "thermal_results": None,
    "thermal_valid_results": None,
    "thermal_R_ohm": None,
}
for k, v in defaults.items():
    if k not in st.session_state:
        st.session_state[k] = v

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HELPERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def cyber_plotly_layout(height=450):
    return dict(
        plot_bgcolor='rgba(245,252,255,0.95)',
        paper_bgcolor='rgba(240,250,255,0.4)',
        font=dict(color='#0a1628', size=12, family='Exo 2, sans-serif'),
        xaxis=dict(
            gridcolor='rgba(0,200,255,0.12)', linecolor='rgba(0,200,255,0.3)',
            tickfont=dict(family='Share Tech Mono', size=11),
            title_font=dict(family='Orbitron, monospace', size=12, color='#0066aa')),
        yaxis=dict(
            gridcolor='rgba(0,200,255,0.12)', linecolor='rgba(0,200,255,0.3)',
            tickfont=dict(family='Share Tech Mono', size=11),
            title_font=dict(family='Orbitron, monospace', size=12, color='#0066aa')),
        height=height, hovermode='x unified',
        legend=dict(bgcolor='rgba(255,255,255,0.9)', bordercolor='rgba(0,200,255,0.4)',
                    borderwidth=2, font=dict(family='Share Tech Mono', size=11, color='#003355')),
        margin=dict(l=20, r=20, t=30, b=20)
    )

def generate_chart_data(points=50):
    t = np.arange(points)
    voltage     = 3.6 + 0.3 * np.sin(t/5) + np.random.normal(0, 0.05, points)
    current     = st.session_state.current + np.random.normal(0, 0.3, points)
    temperature = st.session_state.temperature + np.random.normal(0, 2, points)
    soc         = np.maximum(0, st.session_state.soc - t*0.5 + np.random.normal(0, 1, points))
    return pd.DataFrame({'Time': t, 'Voltage (V)': voltage, 'Current (A)': current,
                         'Temperature (Â°C)': temperature, 'SOC (%)': soc})

def ecm_results_to_df(res):
    """Convert ECM results dict to a downloadable DataFrame."""
    d = {
        "Time (s)":          res["time"],
        "V_measured (V)":    res["V_measured"],
        "V_simulated (V)":   res["V_simulated"],
        "V_error (mV)":      (res["V_measured"] - res["V_simulated"]) * 1000,
        "SOC (fraction)":    res["soc"],
        "SOC (%)":           res["soc"] * 100,
        "Current (A)":       res["current"],
    }
    if "temperature" in res:
        d["Temperature (Â°C)"] = res["temperature"]
    return pd.DataFrame(d)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HEADER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
now_str = datetime.now().strftime("%H:%M:%S | %d %b %Y")
st.markdown(f"""
<div class="cyber-header">
  <div class="header-beam"></div>
  <h1 class="cyber-title">AUTOTWIN</h1>
  <p class="cyber-subtitle">âš¡ REAL-TIME SIMULATION &amp; ANALYTICS PLATFORM âš¡</p>
  <div class="header-stats-bar">
    <span class="hstat"><span class="hstat-dot"></span>SYSTEM ONLINE</span>
    <span class="hstat" style="color:#5a7090;">|</span>
    <span class="hstat">ğŸ• {now_str}</span>
    <span class="hstat" style="color:#5a7090;">|</span>
    <span class="hstat">MODEL: <span style="color:#00c8ff;font-weight:700;">{st.session_state.selected_model}</span></span>
    <span class="hstat" style="color:#5a7090;">|</span>
    <span class="hstat">ECM: <span style="color:{'#00ff88' if st.session_state.ecm_results else '#ff8800'};font-weight:700;">
      {'âœ“ RESULTS READY' if st.session_state.ecm_results else 'NO DATA'}</span></span>
    <span class="hstat" style="color:#5a7090;">|</span>
    <span class="hstat" style="color:#00cc66;">v2.4.1 STABLE</span>
  </div>
</div>
""", unsafe_allow_html=True)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TABS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
tab1, tab2, tab3, tab4, tab5, tab6, tab7 = st.tabs([
    "ğŸ“Š OVERVIEW", "ğŸ”§ MODELS", "â–¶ SIMULATION",
    "ğŸ“ˆ ANALYTICS", "âš™ PARAMETERS", "ğŸ¤– AI RUL", "ğŸ”€ COMPARE"
])

voltage_display = round(3.2 + (st.session_state.soc/100)*0.9, 2)
power_display   = round(voltage_display * st.session_state.current, 1)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 1 â€” OVERVIEW
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab1:
    st.markdown("""
    <div class="tab-header">
      <div class="tab-header-icon">ğŸ“Š</div>
      <div>
        <p class="tab-header-title">SYSTEM OVERVIEW</p>
        <p class="tab-header-subtitle"> real-time monitoring &amp; performance metrics</p>
      </div>
    </div>""", unsafe_allow_html=True)

    # ECM real data if available, else session-state placeholders
    res = st.session_state.ecm_results
    ov_soc  = round(res["soc"][-1] * 100, 1)         if res else st.session_state.soc
    ov_volt = round(res["V_measured"][-1], 3)         if res else voltage_display
    ov_curr = round(abs(res["current"][-1]), 3)       if res else st.session_state.current
    ov_rmse = round(res["metrics"]["RMSE_V"]*1000, 2) if res else 0
    ov_soh  = round(100 - (1 - res["soc"][-1]) * 100 * 0.15, 1) if res else 94

    col1, col2, col3, col4 = st.columns(4)
    cards = [
        (col1, "VOLTAGE",  ov_volt, "V",   "#00c8ff", "LIVE",   "âš¡"),
        (col2, "SOH",      ov_soh,  "%",   "#00ff88", "GOOD",   "ğŸ’š"),
        (col3, "SOC",      ov_soc,  "%",   "#ff8800", "ACTIVE", "ğŸ”‹"),
        (col4, "ECM RMSE", ov_rmse, "mV",  "#cc44ff", "ECM",    "ğŸ“¡"),
    ]
    for col, label, val, unit, color, badge, icon in cards:
        with col:
            st.markdown(f"""
            <div class="metric-card" style="border-color:{color}55;">
              <span class="metric-badge" style="color:{color};border-color:{color}66;background:rgba(0,0,0,0.04);">{badge}</span>
              <div class="metric-label">{icon} {label}</div>
              <div class="metric-value" style="color:{color};text-shadow:0 0 24px {color}88;">{val}</div>
              <div class="metric-unit">{unit}</div>
            </div>""", unsafe_allow_html=True)

    st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)

    col1, col2 = st.columns([2, 1])
    with col1:
        st.markdown("""
        <div class="glass-panel">
          <h3 style="font-size:1.3rem;margin-bottom:4px;">ğŸ“ˆ BATTERY VOLTAGE MONITOR</h3>
          <p style="font-family:'Share Tech Mono',monospace;font-size:0.78rem;color:#5a7090;margin-top:0;letter-spacing:0.1em;">
            measured vs simulated 
          </p>
        </div>""", unsafe_allow_html=True)

        if res:
            fig = go.Figure()
            fig.add_trace(go.Scatter(x=res["time"], y=res["V_measured"],
                name="V Measured", line=dict(color="#00ff88", width=2), mode="lines"))
            fig.add_trace(go.Scatter(x=res["time"], y=res["V_simulated"],
                name="V Simulated (ECM)", line=dict(color="#00c8ff", width=2.5, dash="dash"), mode="lines"))
            layout = cyber_plotly_layout(400)
            layout["xaxis"]["title"] = dict(text="TIME (s)", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
            layout["yaxis"]["title"] = dict(text="VOLTAGE (V)", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
            fig.update_layout(**layout)
            st.plotly_chart(fig, use_container_width=True)
        else:
            df_chart = generate_chart_data()
            fig = go.Figure()
            fig.add_trace(go.Scatter(x=df_chart["Time"], y=df_chart["Voltage (V)"],
                name="Voltage (V)", line=dict(color="#00c8ff", width=3), mode="lines+markers", marker=dict(size=3)))
            layout = cyber_plotly_layout(400)
            layout["xaxis"]["title"] = dict(text="TIME (s)", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
            layout["yaxis"]["title"] = dict(text="VOLTAGE (V)", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
            fig.update_layout(**layout)
            st.plotly_chart(fig, use_container_width=True)
            st.info("ğŸ’¡ Upload a discharge CSV in the **â–¶ ECM SIMULATION** tab to see real results here.")

    with col2:
        st.markdown("""
        <div class="glass-panel">
          <h4 style="font-size:1.1rem;margin:0;">âš¡ SYSTEM STATUS</h4>
        </div>""", unsafe_allow_html=True)
        items = [
            ("ECM Engine",   "ONLINE",  "#00ff88"),
            ("Optimiser",    "READY",   "#00ff88"),
            ("OCV Model",    "CALIBRATED" if res else "STANDBY", "#00ff88" if res else "#ffaa00"),
            ("Data Feed",    "LIVE" if res else "AWAITING", "#00ff88" if res else "#ffaa00"),
        ]
        for label, status, color in items:
            st.markdown(f"""
            <div style="background:rgba(255,255,255,0.95);border:2px solid {color}44;border-radius:12px;
              padding:14px 20px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
              <span style="font-family:'Share Tech Mono',monospace;color:#2a4060;font-size:0.82rem;">{label}</span>
              <span style="font-family:'Orbitron',monospace;color:{color};font-size:0.72rem;font-weight:700;
                text-shadow:0 0 8px {color}66;">{status}</span>
            </div>""", unsafe_allow_html=True)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 2 â€” MODELS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab2:
    st.markdown("""
    <div class="tab-header">
      <div class="tab-header-icon">ğŸ”§</div>
      <div>
        <p class="tab-header-title">MODEL SELECTION</p>
        <p class="tab-header-subtitle"> select your computational approach</p>
      </div>
    </div>""", unsafe_allow_html=True)

    models = {
        "ECM": {
            "name": "Equivalent Circuit Model", "icon": "âš¡", "accuracy": "RÂ²â‰¥0.99", "speed": "Fast",
            "color": "#00c8ff", "grad": "linear-gradient(135deg,#003d5c,#00527a,#006095)",
            "description": "1RC Thevenin Equivalent Circuit Model â€” R0, R1, C1 identified from real discharge data via two-stage global optimisation."
        },
        "Thermal": {
            "name": "Thermal Simulation", "icon": "ğŸŒ¡ï¸", "accuracy": "80%", "speed": "Medium",
            "color": "#ff8800", "grad": "linear-gradient(135deg,#5c2200,#7a3300,#954400)",
            "description": "Models heat generation, dissipation, and thermal runaway in battery cells."
        },
        "Co-Simulation": {
            "name": "Co-Simulation", "icon": "ğŸ”„", "accuracy": "92%", "speed": "Medium",
            "color": "#00ff88", "grad": "linear-gradient(135deg,#003d2a,#00522e,#006035)",
            "description": "Combined multi-domain approach for comprehensive electro-thermal analysis."
        }
    }

    cols = st.columns(3)
    for idx, (key, model) in enumerate(models.items()):
        with cols[idx]:
            is_active = st.session_state.selected_model == key
            if st.button(f"{model['icon']} SELECT {model['icon']}", key=f"model_{key}", use_container_width=True):
                st.session_state.selected_model = key
                st.success(f"âœ… {model['name']} activated!")
                st.rerun()
            card_cls = "model-card-active" if is_active else "model-card"
            txt_col  = "white" if is_active else "#0a1628"
            bg_extra = f'background:{model["grad"]};' if is_active else ''
            border   = f"2px solid {model['color']}" if is_active else f"2px solid {model['color']}55"
            badge_bg = "rgba(255,255,255,0.2)" if is_active else f"{model['color']}18"
            st.markdown(f"""
            <div class="{card_cls}" style="{bg_extra}border:{border};">
              <div style="font-size:4.5rem;text-align:center;filter:drop-shadow(0 0 12px {model['color']}88);">{model['icon']}</div>
              <h3 style="font-family:'Orbitron',monospace;color:{txt_col};font-size:1.1rem;font-weight:800;letter-spacing:0.06em;text-align:center;margin:0.8rem 0 0.6rem;">{model['name']}</h3>
              <p style="color:{'rgba(255,255,255,0.85)' if is_active else '#4a6080'};font-family:'Exo 2',sans-serif;font-size:0.9rem;text-align:center;line-height:1.55;font-weight:500;margin-bottom:1.2rem;">{model['description']}</p>
              <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                <span style="background:{badge_bg};padding:8px 18px;border-radius:20px;color:{txt_col};font-family:'Share Tech Mono',monospace;font-size:0.8rem;border:{border};">ğŸ“Š {model['accuracy']}</span>
                <span style="background:{badge_bg};padding:8px 18px;border-radius:20px;color:{txt_col};font-family:'Share Tech Mono',monospace;font-size:0.8rem;border:{border};">âš¡ {model['speed']}</span>
              </div>
              {'<div style="position:absolute;top:14px;right:14px;background:rgba(0,200,255,0.25);border:1px solid rgba(255,255,255,0.4);border-radius:8px;padding:4px 10px;font-family:Share Tech Mono,monospace;font-size:0.65rem;color:white;letter-spacing:0.1em;">ACTIVE</div>' if is_active else ''}
            </div>""", unsafe_allow_html=True)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 3 â€” ECM SIMULATION  â† THE KEY TAB
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab3:
    _sel = st.session_state.selected_model
    _model_meta = {
        "ECM":           ("â–¶",  "ECM SIMULATION ENGINE",        "Thevenin 1RC Model Â· NASA Battery Dataset Â· Real Parameter Identification"),
        "Thermal":       ("ğŸŒ¡ï¸", "THERMAL SIMULATION",           "Heat generation Â· Dissipation Â· Thermal runaway modelling"),
        "Co-Simulation": ("ğŸ”„", "CO-SIMULATION ENGINE",         "Coupled electro-thermal analysis Â· Multi-domain digital twin"),
    }
    _icon, _title, _sub = _model_meta.get(_sel, ("â–¶", "SIMULATION", ""))
    st.markdown(f"""
    <div class="tab-header">
      <div class="tab-header-icon">{_icon}</div>
      <div>
        <p class="tab-header-title">{_title}</p>
        <p class="tab-header-subtitle">{_sub}</p>
      </div>
    </div>""", unsafe_allow_html=True)

    if _sel == "ECM":
        # â”€â”€ Upload + Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Mode selector: Upload new files  vs  Auto-load from results folder
        mode_col, _ = st.columns([2, 1])
        with mode_col:
            load_mode = st.radio(
                "Input mode",
                ["â¬† Upload new CSV files", "ğŸ“ Load from results folder"],
                horizontal=True,
                label_visibility="collapsed"
            )

        st.markdown("<div style='height:10px'></div>", unsafe_allow_html=True)

        # â”€â”€ MODE A: Upload new CSV files (original behaviour) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if load_mode == "â¬† Upload new CSV files":
            st.markdown("""
            <div class="glass-panel">
              <h4 style="font-size:1.15rem;margin:0 0 6px;">ğŸ“‚ LOAD NASA DISCHARGE FILES</h4>
              <p style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
                Upload one <b>or multiple</b> B0043/B0045/B0047/B0048 discharge CSVs â€” each file is one cycle
              </p>
            </div>""", unsafe_allow_html=True)

            up_col, cfg_col = st.columns([2, 1])
            with up_col:
                uploaded_files = st.file_uploader(
                    "Upload discharge CSV(s)",
                    type=["csv"],
                    accept_multiple_files=True,
                    help="Select multiple files with Ctrl/Cmd+click. Each file = one discharge cycle.",
                    label_visibility="collapsed"
                )
                uploaded_file = uploaded_files[-1] if uploaded_files else None

            with cfg_col:
                st.markdown("""
                <div style="background:rgba(255,255,255,0.97);border:2px solid rgba(0,200,255,0.35);
                  border-radius:14px;padding:20px;margin-bottom:12px;">
                  <div style="font-family:'Orbitron',monospace;color:#005f8a;font-size:0.75rem;font-weight:700;letter-spacing:0.1em;margin-bottom:8px;">
                    âš¡ NOMINAL CAPACITY (Ah)
                  </div>
                </div>""", unsafe_allow_html=True)
                q_nom = st.slider("Q_nominal (Ah)", min_value=0.5, max_value=3.0,
                                  value=st.session_state.ecm_qnom, step=0.1,
                                  label_visibility="collapsed")
                st.session_state.ecm_qnom = q_nom
                st.markdown(f"""
                <div style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:#5a7090;
                  text-align:center;margin-top:-10px;">
                  Q_nom = <span style="color:#00c8ff;font-weight:700;">{q_nom:.1f} Ah</span>
                  &nbsp;|&nbsp; Fresh cell: 2.0 Ah &nbsp;|&nbsp; Adjust for aged batteries
                </div>""", unsafe_allow_html=True)

        # â”€â”€ MODE B: Auto-load from pre-computed results folder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        else:
            uploaded_files = []
            uploaded_file  = None
            q_nom          = st.session_state.ecm_qnom

            st.markdown("""
            <div class="glass-panel">
              <h4 style="font-size:1.15rem;margin:0 0 6px;">ğŸ“ AUTO-LOAD FROM RESULTS FOLDER</h4>
              <p style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
                Point to the folder created by batch_run.py â€” select files to display instantly, no re-processing needed
              </p>
            </div>""", unsafe_allow_html=True)

            folder_col, _ = st.columns([2, 1])
            with folder_col:
                results_folder = st.text_input(
                    "Results folder path",
                    value=st.session_state.ecm_results_folder or "",
                    placeholder="e.g.  Battery43/results/   or   C:/AUTOTWIN/Battery43/results/",
                    label_visibility="collapsed"
                )
                if results_folder:
                    st.session_state.ecm_results_folder = results_folder

            # Scan the folder for pre-computed ECM result CSVs
            import glob as _glob
            _result_files = []
            if results_folder and os.path.isdir(results_folder):
                _result_files = sorted(_glob.glob(os.path.join(results_folder, "*_ecm.csv")))

            if results_folder and not os.path.isdir(results_folder):
                st.markdown("""
                <div style="background:rgba(255,180,0,0.08);border:1px solid rgba(255,180,0,0.4);
                  border-radius:10px;padding:12px 16px;margin-top:8px;">
                  <span style="font-family:'Share Tech Mono',monospace;font-size:0.78rem;color:#cc8800;">
                    âš  Folder not found â€” check the path above
                  </span>
                </div>""", unsafe_allow_html=True)
            elif _result_files:
                st.markdown(f"""
                <div style="background:rgba(0,255,136,0.06);border:1px solid rgba(0,255,136,0.3);
                  border-radius:10px;padding:10px 16px;margin:8px 0;">
                  <span style="font-family:'Share Tech Mono',monospace;font-size:0.78rem;color:#00aa55;">
                    âœ“ {len(_result_files)} pre-computed result file(s) found
                  </span>
                </div>""", unsafe_allow_html=True)

                _file_names = [os.path.basename(f) for f in _result_files]
                selected_names = st.multiselect(
                    "Select files to load",
                    options=_file_names,
                    default=_file_names[:1],
                    help="Select one for individual view, multiple for batch comparison",
                    label_visibility="collapsed"
                )
                _selected_paths = [os.path.join(results_folder, n) for n in selected_names]

                # Load button â€” reads CSVs and reconstructs results dicts instantly
                load_btn = st.button("âš¡ LOAD SELECTED FILES", use_container_width=True,
                                     disabled=(len(selected_names) == 0))

                if load_btn and _selected_paths:
                    _loaded = []
                    _prog   = st.progress(0)
                    for _fi, _fp in enumerate(_selected_paths):
                        try:
                            _df = pd.read_csv(_fp)
                            # Reconstruct the results dict from the saved CSV columns
                            _res = {
                                "_filename":   selected_names[_fi].replace("_ecm.csv", ".csv"),
                                "time":        _df["Time_s"].values,
                                "V_measured":  _df["V_meas_V"].values,
                                "V_simulated": _df["V_sim_V"].values,
                                "soc":         _df["SOC"].values,
                                "current":     _df["Current_A"].values,
                                "temperature": _df["Temp_C"].values if "Temp_C" in _df.columns else np.full(len(_df), np.nan),
                                "Q_nominal_Ah": st.session_state.ecm_qnom,
                                "params": {
                                    "R0_ohm": 0.0, "R1_ohm": 0.0,
                                    "C1_F": 0.0,   "tau_s": 0.0,
                                },
                                "metrics": {
                                    "RMSE_V":    float(np.sqrt(np.mean((_df["V_meas_V"].values - _df["V_sim_V"].values)**2))),
                                    "MAE_V":     float(np.mean(np.abs(_df["V_meas_V"].values - _df["V_sim_V"].values))),
                                    "R2":        float(1 - np.sum((_df["V_meas_V"].values - _df["V_sim_V"].values)**2) / max(np.sum((_df["V_meas_V"].values - _df["V_meas_V"].values.mean())**2), 1e-12)),
                                    "MaxErr_V":  float(np.max(np.abs(_df["V_meas_V"].values - _df["V_sim_V"].values))),
                                    "MAPE_pct":  float(np.mean(np.abs((_df["V_meas_V"].values - _df["V_sim_V"].values) / np.where(np.abs(_df["V_meas_V"].values) > 1e-6, _df["V_meas_V"].values, 1e-6))) * 100),
                                },
                            }
                            # Load params from summary CSV if it exists
                            _summary_path = os.path.join(results_folder, "batch_ecm_summary.csv")
                            if os.path.isfile(_summary_path):
                                _sum = pd.read_csv(_summary_path)
                                _row = _sum[_sum["File"] == selected_names[_fi].replace("_ecm.csv", ".csv")]
                                if not _row.empty:
                                    _res["params"] = {
                                        "R0_ohm": float(_row["R0_mOhm"].iloc[0]) / 1000,
                                        "R1_ohm": float(_row["R1_mOhm"].iloc[0]) / 1000,
                                        "C1_F":   float(_row["C1_F"].iloc[0]),
                                        "tau_s":  float(_row["tau_s"].iloc[0]),
                                    }
                            _loaded.append(_res)
                        except Exception as _e:
                            st.warning(f"Could not load {selected_names[_fi]}: {_e}")
                        _prog.progress(int((_fi + 1) / len(_selected_paths) * 100))

                    if _loaded:
                        st.session_state.ecm_batch_results = _loaded
                        st.session_state.ecm_results       = _loaded[-1]
                        st.session_state.ecm_filename      = _loaded[-1]["_filename"]
                        st.markdown(f"""
                        <div style="background:rgba(0,255,136,0.08);border:2px solid rgba(0,255,136,0.5);
                          border-radius:14px;padding:16px;text-align:center;margin-top:10px;">
                          <div style="font-family:'Orbitron',monospace;color:#00ff88;font-size:1.3rem;font-weight:900;">
                            âœ“ {len(_loaded)} FILE(S) LOADED INSTANTLY
                          </div>
                          <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.78rem;margin-top:6px;">
                            No re-processing needed Â· results loaded from disk
                          </div>
                        </div>""", unsafe_allow_html=True)

            elif results_folder:
                st.markdown("""
                <div style="background:rgba(255,180,0,0.08);border:1px solid rgba(255,180,0,0.4);
                  border-radius:10px;padding:12px 16px;margin-top:8px;">
                  <span style="font-family:'Share Tech Mono',monospace;font-size:0.78rem;color:#cc8800;">
                    âš  No *_ecm.csv files found â€” run batch_run.py first to generate results
                  </span>
                </div>""", unsafe_allow_html=True)

        st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)

        # â”€â”€ RUN BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        run_col, status_col = st.columns([1, 2])

        with run_col:
            n_files = len(uploaded_files) if uploaded_files else 0
            btn_label = f"âš¡ RUN {n_files} FILE{'S' if n_files != 1 else ''}" if n_files > 1 else "âš¡ RUN THEVENIN ECM"
            run_btn = st.button(btn_label, use_container_width=True, disabled=(n_files == 0))
            if n_files == 0:
                st.markdown("""
                <div style="text-align:center;font-family:'Share Tech Mono',monospace;
                  color:#ffaa00;font-size:0.75rem;letter-spacing:0.1em;margin-top:8px;">
                  âš  Upload one or more CSV files to enable simulation
                </div>""", unsafe_allow_html=True)
            elif n_files > 1:
                st.markdown(f"""
                <div style="text-align:center;font-family:'Share Tech Mono',monospace;
                  color:#00c8ff;font-size:0.75rem;letter-spacing:0.1em;margin-top:8px;">
                  ğŸ“‚ {n_files} files queued for batch processing
                </div>""", unsafe_allow_html=True)

        with status_col:
            ecm_status_box = st.empty()

        # â”€â”€ RUN ECM â€” batch loop over all uploaded files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if run_btn and uploaded_files:
            batch_results = []
            overall_prog  = st.progress(0)

            for file_idx, uf in enumerate(uploaded_files):
                pct_start = int(file_idx / len(uploaded_files) * 100)
                pct_end   = int((file_idx + 1) / len(uploaded_files) * 100)

                ecm_status_box.markdown(f"""
                <div style="background:rgba(0,200,255,0.08);border:2px solid rgba(0,200,255,0.4);
                  border-radius:14px;padding:20px;text-align:center;">
                  <div style="font-family:'Orbitron',monospace;color:#00c8ff;font-size:1.3rem;
                    font-weight:900;text-shadow:0 0 20px rgba(0,200,255,0.5);">
                    â³ PROCESSING {file_idx+1}/{len(uploaded_files)}: {uf.name}
                  </div>
                  <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.78rem;
                    letter-spacing:0.1em;margin-top:6px;">
                    Stage 1 â€” Differential Evolution Â· Stage 2 â€” L-BFGS-B
                  </div>
                </div>""", unsafe_allow_html=True)
                overall_prog.progress(pct_start + 5)

                try:
                    raw_df  = TheveninECM.load_uploaded(uf)
                    overall_prog.progress(pct_start + int((pct_end - pct_start) * 0.2))
                    ecm     = TheveninECM()
                    results = ecm.run(raw_df, Q_nominal_Ah=q_nom, verbose=False)
                    results["_filename"] = uf.name          # tag result with filename
                    batch_results.append(results)
                    overall_prog.progress(pct_end)

                except Exception as e:
                    ecm_status_box.markdown(f"""
                    <div style="background:rgba(255,0,100,0.08);border:2px solid rgba(255,50,100,0.5);
                      border-radius:14px;padding:20px;text-align:center;">
                      <div style="font-family:'Orbitron',monospace;color:#ff3366;font-size:1.1rem;font-weight:900;">
                        âœ— ERROR â€” {uf.name}
                      </div>
                      <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.75rem;margin-top:6px;">
                        {str(e)}
                      </div>
                    </div>""", unsafe_allow_html=True)
                    continue   # skip broken file, keep going with others

            # Store results â€” last file feeds the single-result display below
            if batch_results:
                st.session_state.ecm_batch_results = batch_results
                st.session_state.ecm_results       = batch_results[-1]
                st.session_state.ecm_filename      = batch_results[-1]["_filename"]

                n_ok = len(batch_results)
                avg_r2   = sum(r["metrics"]["R2"]       for r in batch_results) / n_ok
                avg_rmse = sum(r["metrics"]["RMSE_V"]   for r in batch_results) / n_ok

                ecm_status_box.markdown(f"""
                <div style="background:rgba(0,255,136,0.08);border:2px solid rgba(0,255,136,0.5);
                  border-radius:14px;padding:20px;text-align:center;">
                  <div style="font-family:'Orbitron',monospace;color:#00ff88;font-size:1.4rem;font-weight:900;
                    text-shadow:0 0 20px rgba(0,255,136,0.5);">
                    âœ“ BATCH COMPLETE â€” {n_ok}/{len(uploaded_files)} FILES
                  </div>
                  <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.8rem;
                    letter-spacing:0.1em;margin-top:8px;">
                    Avg RMSE = {avg_rmse*1000:.2f} mV &nbsp;|&nbsp;
                    Avg RÂ² = {avg_r2:.4f} &nbsp;|&nbsp;
                    Q_nom = {q_nom:.1f} Ah
                  </div>
                </div>""", unsafe_allow_html=True)
                overall_prog.progress(100)

        # â”€â”€ BATCH COMPARISON TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        batch = st.session_state.get("ecm_batch_results", [])
        if len(batch) > 1:
            st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)
            st.markdown("""
            <div class="glass-panel">
              <h4 style="font-size:1.15rem;margin:0 0 6px;">ğŸ“Š BATCH COMPARISON â€” ALL FILES</h4>
              <p style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
                Identified ECM parameters and accuracy metrics across all processed discharge files
              </p>
            </div>""", unsafe_allow_html=True)

            table_rows = []
            for r in batch:
                p = r["params"]; m = r["metrics"]; s = r["soc"]
                table_rows.append({
                    "File":       r.get("_filename", "â€”"),
                    "Râ‚€ (mÎ©)":   f"{p['R0_ohm']*1000:.2f}",
                    "Râ‚ (mÎ©)":   f"{p['R1_ohm']*1000:.2f}",
                    "Câ‚ (F)":    f"{p['C1_F']:.1f}",
                    "Ï„ (s)":      f"{p['tau_s']:.2f}",
                    "RMSE (mV)":  f"{m['RMSE_V']*1000:.2f}",
                    "MAE (mV)":   f"{m['MAE_V']*1000:.2f}",
                    "RÂ²":         f"{m['R2']:.4f}",
                    "MaxErr (mV)":f"{m['MaxErr_V']*1000:.2f}",
                    "SOC start":  f"{s[0]*100:.1f}%",
                    "SOC end":    f"{s[-1]*100:.1f}%",
                    "DoD":        f"{(s[0]-s[-1])*100:.1f}%",
                })
            cmp_df = pd.DataFrame(table_rows)
            st.dataframe(cmp_df, use_container_width=True, hide_index=True)

            # Download all results as one merged CSV
            all_rows = []
            for r in batch:
                fn = r.get("_filename", "file")
                n  = len(r["time"])
                chunk = pd.DataFrame({
                    "File":        [fn]*n,
                    "Time (s)":    r["time"],
                    "V_meas (V)":  r["V_measured"],
                    "V_sim (V)":   r["V_simulated"],
                    "Err (mV)":    (r["V_measured"] - r["V_simulated"]) * 1000,
                    "SOC":         r["soc"],
                    "Current (A)": r["current"],
                })
                if "temperature" in r:
                    chunk["Temp (Â°C)"] = r["temperature"]
                all_rows.append(chunk)
            merged_df = pd.concat(all_rows, ignore_index=True)
            st.download_button(
                "â¬‡ DOWNLOAD ALL RESULTS (CSV)",
                data=merged_df.to_csv(index=False),
                file_name="autotwin_batch_ecm_results.csv",
                mime="text/csv",
                use_container_width=True
            )

            # Voltage overlay chart â€” all files on one plot
            st.markdown("<br>", unsafe_allow_html=True)
            st.markdown("""
            <div class="glass-panel">
              <h4 style="font-size:1.15rem;margin:0 0 6px;">ğŸ“ˆ VOLTAGE â€” ALL FILES OVERLAY</h4>
            </div>""", unsafe_allow_html=True)

            fig_ov = go.Figure()
            colors = ["#00c8ff","#00ff88","#ff8800","#cc44ff","#ff3366","#ffd700","#00ffcc","#ff6644"]
            for idx, r in enumerate(batch):
                c   = colors[idx % len(colors)]
                fn  = r.get("_filename","file")
                fig_ov.add_trace(go.Scatter(x=r["time"], y=r["V_measured"],
                    name=f"{fn} measured", line=dict(color=c, width=1.4, dash="dot"),
                    opacity=0.7))
                fig_ov.add_trace(go.Scatter(x=r["time"], y=r["V_simulated"],
                    name=f"{fn} ECM", line=dict(color=c, width=2.2)))
            fig_ov.update_layout(**cyber_plotly_layout(360),
                xaxis_title="Time (s)", yaxis_title="Voltage (V)")
            st.plotly_chart(fig_ov, use_container_width=True)

            # SOC overlay chart
            fig_soc = go.Figure()
            for idx, r in enumerate(batch):
                c  = colors[idx % len(colors)]
                fn = r.get("_filename","file")
                t_rel = r["time"] - r["time"][0]     # normalise to t=0 for each file
                fig_soc.add_trace(go.Scatter(x=t_rel, y=r["soc"]*100,
                    name=fn, line=dict(color=c, width=2.0)))
            fig_soc.update_layout(**cyber_plotly_layout(300),
                xaxis_title="Time from discharge start (s)", yaxis_title="SOC (%)")
            st.plotly_chart(fig_soc, use_container_width=True)

            st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)
            st.markdown("""
            <div style="background:rgba(0,200,255,0.06);border:1px solid rgba(0,200,255,0.3);
              border-radius:12px;padding:14px 20px;">
              <span style="font-family:'Share Tech Mono',monospace;font-size:0.8rem;color:#2a4060;">
                â„¹ Individual file results shown below are for the <b>last processed file</b>.
                Use the download button above to export all files' data.
              </span>
            </div>""", unsafe_allow_html=True)

        # â”€â”€ RESULTS DISPLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        res = st.session_state.ecm_results
        if res:
            fname = st.session_state.ecm_filename or "discharge.csv"
            params  = res["params"]
            metrics = res["metrics"]
            soc     = res["soc"]

            st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)
            st.markdown(f"""
            <div class="glass-panel">
              <h4 style="font-size:1.15rem;margin:0 0 6px;">âœ… ECM RESULTS â€” {fname}</h4>
              <p style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
                Thevenin 1RC Â· {len(res['time'])} discharge samples Â· Q_nom = {res['Q_nominal_Ah']} Ah
              </p>
            </div>""", unsafe_allow_html=True)

            # â”€â”€ Parameters Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            p1, p2, p3, p4 = st.columns(4)
            param_cards = [
                (p1, "Râ‚€ (OHMIC)",   f"{params['R0_ohm']*1000:.2f}", "mÎ©", "#00c8ff",
                 "Internal / ohmic resistance"),
                (p2, "Râ‚ (CT RES)", f"{params['R1_ohm']*1000:.2f}", "mÎ©", "#ff00c8",
                 "Charge-transfer resistance"),
                (p3, "Câ‚ (DL CAP)", f"{params['C1_F']:.1f}", "F",  "#00ff88",
                 "Double-layer capacitance"),
                (p4, "Ï„ = Râ‚Â·Câ‚",   f"{params['tau_s']:.2f}", "s",  "#ffd700",
                 "RC time constant"),
            ]
            for col, label, val, unit, color, desc in param_cards:
                with col:
                    st.markdown(f"""
                    <div class="ecm-result-card">
                      <div style="font-family:'Orbitron',monospace;color:{color};font-size:0.65rem;
                        font-weight:700;letter-spacing:0.15em;margin-bottom:10px;">{label}</div>
                      <div style="font-family:'Orbitron',monospace;color:white;font-size:2.6rem;
                        font-weight:900;text-shadow:0 0 20px {color}88;line-height:1;">{val}</div>
                      <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.7);
                        font-size:0.85rem;margin-top:4px;">{unit}</div>
                      <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.5);
                        font-size:0.68rem;margin-top:8px;letter-spacing:0.06em;">{desc}</div>
                    </div>""", unsafe_allow_html=True)

            st.markdown("<br>", unsafe_allow_html=True)

            # â”€â”€ Accuracy Metrics Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            m1, m2, m3, m4, m5 = st.columns(5)
            accuracy_pct = round(metrics['R2'] * 100, 2)
            metric_cards = [
                (m1, "RMSE",  f"{metrics['RMSE_V']*1000:.2f}", "mV",  "#00c8ff"),
                (m2, "MAE",   f"{metrics['MAE_V']*1000:.2f}",  "mV",  "#ff8800"),
                (m3, "RÂ²",    f"{metrics['R2']:.4f}",           "",    "#00ff88"),
                (m4, "MAX|Îµ|",f"{metrics['MaxErr_V']*1000:.1f}","mV",  "#ff3366"),
                (m5, "MAPE",  f"{metrics['MAPE_pct']:.3f}",     "%",   "#cc44ff"),
            ]
            for col, label, val, unit, color in metric_cards:
                with col:
                    st.markdown(f"""
                    <div style="background:rgba(255,255,255,0.97);border:2px solid {color}44;
                      border-radius:14px;padding:18px;text-align:center;margin-bottom:16px;
                      box-shadow:0 6px 20px {color}22;">
                      <div style="font-family:'Orbitron',monospace;color:#5a7090;font-size:0.65rem;
                        letter-spacing:0.18em;margin-bottom:8px;">{label}</div>
                      <div style="font-family:'Orbitron',monospace;color:{color};font-size:1.8rem;
                        font-weight:900;text-shadow:0 0 16px {color}88;">{val}</div>
                      <div style="font-family:'Share Tech Mono',monospace;color:#8a9ab0;font-size:0.8rem;">{unit}</div>
                    </div>""", unsafe_allow_html=True)

            # â”€â”€ SOC Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            st.markdown(f"""
            <div style="background:linear-gradient(135deg,rgba(0,50,90,0.95),rgba(0,80,130,0.90));
              border:2px solid #00c8ff;border-radius:16px;padding:18px 28px;margin-bottom:24px;
              display:flex;gap:40px;align-items:center;flex-wrap:wrap;
              box-shadow:0 8px 28px rgba(0,200,255,0.3);">
              <div style="text-align:center;">
                <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.7);font-size:0.68rem;letter-spacing:0.1em;margin-bottom:4px;">INITIAL SOC</div>
                <div style="font-family:'Orbitron',monospace;color:#00c8ff;font-size:2rem;font-weight:900;">{soc[0]*100:.1f}<span style="font-size:1rem;">%</span></div>
              </div>
              <div style="font-family:'Orbitron',monospace;color:rgba(0,200,255,0.4);font-size:2rem;">â†’</div>
              <div style="text-align:center;">
                <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.7);font-size:0.68rem;letter-spacing:0.1em;margin-bottom:4px;">FINAL SOC</div>
                <div style="font-family:'Orbitron',monospace;color:#00ff88;font-size:2rem;font-weight:900;">{soc[-1]*100:.1f}<span style="font-size:1rem;">%</span></div>
              </div>
              <div style="font-family:'Orbitron',monospace;color:rgba(0,200,255,0.4);font-size:2rem;">|</div>
              <div style="text-align:center;">
                <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.7);font-size:0.68rem;letter-spacing:0.1em;margin-bottom:4px;">DEPTH OF DISCHARGE</div>
                <div style="font-family:'Orbitron',monospace;color:#ff8800;font-size:2rem;font-weight:900;">{(soc[0]-soc[-1])*100:.1f}<span style="font-size:1rem;">%</span></div>
              </div>
              <div style="font-family:'Orbitron',monospace;color:rgba(0,200,255,0.4);font-size:2rem;">|</div>
              <div style="text-align:center;">
                <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.7);font-size:0.68rem;letter-spacing:0.1em;margin-bottom:4px;">DURATION</div>
                <div style="font-family:'Orbitron',monospace;color:#cc44ff;font-size:2rem;font-weight:900;">{res['time'][-1]:.0f}<span style="font-size:1rem;">s</span></div>
              </div>
              <div style="font-family:'Orbitron',monospace;color:rgba(0,200,255,0.4);font-size:2rem;">|</div>
              <div style="text-align:center;">
                <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.7);font-size:0.68rem;letter-spacing:0.1em;margin-bottom:4px;">MODEL ACCURACY</div>
                <div style="font-family:'Orbitron',monospace;color:#00ff88;font-size:2rem;font-weight:900;">{accuracy_pct:.1f}<span style="font-size:1rem;">%</span></div>
              </div>
            </div>""", unsafe_allow_html=True)

            # â”€â”€ Voltage Plot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            st.markdown("""
            <div class="glass-panel">
              <h4 style="font-size:1.15rem;margin:0 0 6px;">ğŸ“ˆ VOLTAGE â€” MEASURED vs ECM SIMULATED</h4>
              <p style="font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
                Green = actual battery Â· Cyan dashed = Thevenin 1RC model
              </p>
            </div>""", unsafe_allow_html=True)

            fig_v = go.Figure()
            fig_v.add_trace(go.Scatter(x=res["time"], y=res["V_measured"],
                name="V Measured", line=dict(color="#00ff88", width=2.5), mode="lines"))
            fig_v.add_trace(go.Scatter(x=res["time"], y=res["V_simulated"],
                name="V Simulated (ECM)", line=dict(color="#00c8ff", width=2.5, dash="dash"), mode="lines"))
            layout_v = cyber_plotly_layout(400)
            layout_v["xaxis"]["title"] = dict(text="TIME (s)", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
            layout_v["yaxis"]["title"] = dict(text="VOLTAGE (V)", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
            layout_v["annotations"] = [{
                "text": f"Râ‚€={params['R0_ohm']*1000:.1f}mÎ© | Râ‚={params['R1_ohm']*1000:.1f}mÎ© | Câ‚={params['C1_F']:.0f}F | Ï„={params['tau_s']:.1f}s",
                "xref": "paper", "yref": "paper", "x": 0.01, "y": 0.03,
                "showarrow": False, "font": dict(family="Share Tech Mono", size=10, color="#003355"),
                "bgcolor": "rgba(255,255,255,0.9)", "bordercolor": "rgba(0,200,255,0.4)", "borderwidth": 1
            }]
            fig_v.update_layout(**layout_v)
            st.plotly_chart(fig_v, use_container_width=True)

            # â”€â”€ Error + SOC side by side â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            ec1, ec2 = st.columns(2)
            with ec1:
                st.markdown("""
                <div class="glass-panel" style="border-color:rgba(255,0,200,0.3);">
                  <h4 style="color:#cc0099;font-size:1.05rem;margin:0 0 4px;">âš  PREDICTION ERROR</h4>
                  <p style="font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
                    Measured âˆ’ Simulated (mV)
                  </p>
                </div>""", unsafe_allow_html=True)
                err_mV = (res["V_measured"] - res["V_simulated"]) * 1000
                fig_err = go.Figure()
                fig_err.add_trace(go.Scatter(x=res["time"], y=err_mV,
                    name="Error (mV)", line=dict(color="#ff00c8", width=1.8),
                    fill="tozeroy", fillcolor="rgba(255,0,200,0.08)", mode="lines"))
                fig_err.add_hline(y=0, line=dict(color="black", width=1, dash="dash"))
                layout_err = cyber_plotly_layout(320)
                layout_err["xaxis"]["title"] = dict(text="TIME (s)", font=dict(family="Orbitron,monospace", size=10))
                layout_err["yaxis"]["title"] = dict(text="ERROR (mV)", font=dict(family="Orbitron,monospace", size=10))
                layout_err["showlegend"] = False
                fig_err.update_layout(**layout_err)
                st.plotly_chart(fig_err, use_container_width=True)

            with ec2:
                st.markdown("""
                <div class="glass-panel" style="border-color:rgba(0,255,136,0.3);">
                  <h4 style="color:#00aa55;font-size:1.05rem;margin:0 0 4px;">ğŸ”‹ STATE OF CHARGE (SOC)</h4>
                  <p style="font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
                    Coulomb counting from discharge data
                  </p>
                </div>""", unsafe_allow_html=True)
                fig_soc = go.Figure()
                fig_soc.add_trace(go.Scatter(x=res["time"], y=soc*100,
                    name="SOC (%)", line=dict(color="#00ff88", width=2.5),
                    fill="tozeroy", fillcolor="rgba(0,255,136,0.08)", mode="lines"))
                layout_soc = cyber_plotly_layout(320)
                layout_soc["xaxis"]["title"] = dict(text="TIME (s)", font=dict(family="Orbitron,monospace", size=10))
                layout_soc["yaxis"]["title"] = dict(text="SOC (%)", font=dict(family="Orbitron,monospace", size=10))
                layout_soc["yaxis"]["range"]  = [-5, 105]
                layout_soc["showlegend"] = False
                fig_soc.update_layout(**layout_soc)
                st.plotly_chart(fig_soc, use_container_width=True)

            # â”€â”€ Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)
            dl_df  = ecm_results_to_df(res)
            base   = os.path.splitext(fname)[0]
            st.download_button(
                label="â¬‡ DOWNLOAD ECM RESULTS CSV",
                data=dl_df.to_csv(index=False).encode("utf-8"),
                file_name=f"{base}_ecm_output.csv",
                mime="text/csv",
                use_container_width=True
            )

        else:
            # No results yet â€” show instruction panel
            st.markdown("""
            <div style="background:linear-gradient(145deg,rgba(255,255,255,0.98),rgba(224,248,255,0.92));
              border:2px solid rgba(0,200,255,0.3);border-radius:22px;padding:60px 40px;text-align:center;
              box-shadow:0 6px 28px rgba(0,0,0,0.07);">
              <div style="font-size:7rem;margin-bottom:1.5rem;filter:drop-shadow(0 0 16px rgba(0,200,255,0.4));">âš¡</div>
              <div style="font-family:'Orbitron',monospace;font-size:1.8rem;font-weight:900;color:#0a1628;
                letter-spacing:0.08em;text-shadow:0 0 20px rgba(0,200,255,0.3);margin-bottom:0.8rem;">
                AWAITING DISCHARGE FILE
              </div>
              <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.9rem;
                letter-spacing:0.1em;line-height:1.8;max-width:520px;margin:0 auto 2rem;">
                Upload a NASA discharge CSV (B0043, B0045, B0047, B0048â€¦)<br>
                Set Q_nominal for aged cells<br>
                Click âš¡ RUN THEVENIN ECM
              </div>
              <div style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;">
                <div style="background:rgba(0,200,255,0.08);border:1px solid rgba(0,200,255,0.3);border-radius:12px;padding:12px 24px;">
                  <span style="font-family:'Share Tech Mono',monospace;color:#00c8ff;font-size:0.8rem;">Required columns</span><br>
                  <span style="font-family:'Orbitron',monospace;color:#0a1628;font-size:0.75rem;font-weight:700;">Voltage_measured Â· Current_measured Â· Time</span>
                </div>
                <div style="background:rgba(0,255,136,0.08);border:1px solid rgba(0,255,136,0.3);border-radius:12px;padding:12px 24px;">
                  <span style="font-family:'Share Tech Mono',monospace;color:#00ff88;font-size:0.8rem;">ECM Target</span><br>
                  <span style="font-family:'Orbitron',monospace;color:#0a1628;font-size:0.75rem;font-weight:700;">RÂ² â‰¥ 0.99 Â· RMSE &lt; 20 mV</span>
                </div>
              </div>
            </div>""", unsafe_allow_html=True)

    elif _sel == "Thermal":

        # â”€â”€ THERMAL MODEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        st.markdown("""
        <div class="glass-panel">
          <h4 style="font-size:1.15rem;margin:0 0 6px;">&#x1F321;&#xFE0F; LUMPED THERMAL MODEL</h4>
          <p style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
            Upload <b>Charge</b> files for calibration and <b>Validation</b> files with Temperature_measured.
            C_th and hA are estimated automatically. R is reused from the last ECM run.
          </p>
        </div>""", unsafe_allow_html=True)

        ecm_res = st.session_state.ecm_results
        R_ecm = (ecm_res["params"]["R0_ohm"] if ecm_res else None)

        r_col, info_col = st.columns([1, 2])
        with r_col:
            if R_ecm:
                R_display = round(R_ecm * 1000, 3)
                st.markdown(f"""
                <div style="background:rgba(0,200,255,0.08);border:2px solid rgba(0,200,255,0.4);
                            border-radius:14px;padding:18px;text-align:center;">
                  <div style="font-family:'Orbitron',monospace;color:#5a7090;font-size:0.65rem;
                              letter-spacing:0.15em;margin-bottom:6px;">R (FROM ECM)</div>
                  <div style="font-family:'Orbitron',monospace;color:#00c8ff;font-size:2.2rem;
                              font-weight:900;">{R_display}</div>
                  <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.82rem;">m&#937; (R0)</div>
                </div>""", unsafe_allow_html=True)
                st.session_state.thermal_R_ohm = R_ecm
            else:
                st.markdown("""
                <div style="background:rgba(255,180,0,0.08);border:2px solid rgba(255,180,0,0.4);
                            border-radius:14px;padding:18px;text-align:center;">
                  <div style="font-family:'Share Tech Mono',monospace;color:#cc8800;font-size:0.78rem;">
                    No ECM result found. Run ECM first for accurate R,
                    or default R = 80 m&#937; will be used.
                  </div>
                </div>""", unsafe_allow_html=True)
        with info_col:
            st.markdown("""
            <div style="background:rgba(255,136,0,0.06);border:1px solid rgba(255,136,0,0.25);
                        border-radius:12px;padding:16px 20px;">
              <div style="font-family:'Orbitron',monospace;color:#cc6600;font-size:0.72rem;
                          font-weight:700;letter-spacing:0.1em;margin-bottom:8px;">THERMAL MODEL EQUATION</div>
              <div style="font-family:'Share Tech Mono',monospace;color:#2a4060;font-size:0.82rem;line-height:2;">
                T[k+1] = T[k] + (dt / C_th) x ( I[k]^2 x R - hA x (T[k] - T_amb) )<br>
                <span style="color:#5a7090;font-size:0.75rem;">
                C_th: thermal capacitance (J/K) | hA: heat-transfer coeff (W/K) | R: ECM resistance (Ohm)
                </span>
              </div>
            </div>""", unsafe_allow_html=True)

        st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)

        th_mode = st.radio(
            "Load Mode", ["âš¡ Auto Load (from batch results)", "ğŸ“‚ Manual Upload"],
            horizontal=True, key="th_load_mode", label_visibility="collapsed")

        st.markdown("<div style='height:8px'></div>", unsafe_allow_html=True)

        calib_files = []
        valid_files = []

        if th_mode == "âš¡ Auto Load (from batch results)":
            st.markdown("""
            <div class="glass-panel" style="border-color:rgba(255,136,0,0.3);">
              <h4 style="font-size:1.05rem;margin:0 0 6px;">âš¡ AUTO LOAD â€” Batch Results Folder</h4>
              <p style="font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:#5a7090;margin:0;">
                Point to the thermal_results folder generated by batch_thermal_run.py
              </p>
            </div>""", unsafe_allow_html=True)

            al1, al2 = st.columns([3, 1], gap="medium")
            with al1:
                results_folder = st.text_input(
                    "Results Folder Path",
                    value=st.session_state.get("th_results_folder", ""),
                    placeholder="e.g.  Battery47/discharge/thermal_results",
                    key="th_results_folder_input",
                    label_visibility="collapsed")
            with al2:
                load_btn = st.button("ğŸ“‚ LOAD RESULTS", use_container_width=True, key="th_load_btn")

            if load_btn and results_folder:
                import pandas as _pd
                import numpy as _np
                params_path   = os.path.join(results_folder, "thermal_params.csv")
                valid_summary = os.path.join(results_folder, "batch_valid_summary.csv")
                if not os.path.isfile(params_path):
                    st.error(f"thermal_params.csv not found in: {results_folder}")
                else:
                    p = _pd.read_csv(params_path).iloc[0]
                    C_th_l  = float(p["C_th_J_K"])
                    hA_l    = float(p["hA_W_K"])
                    T_amb_l = float(p["T_amb_C"])
                    R_l     = float(p["R_ohm"])
                    n_files = int(p.get("n_calib_files", 0))
                    best_file_raw = str(p.get("best_file", ""))
                    # Build prediction file path
                    if "/" in best_file_raw:
                        parts = best_file_raw.split("/")
                        pred_fname = f"{parts[0]}_{parts[1].replace('.csv','_thermal.csv')}"
                    else:
                        pred_fname = best_file_raw.replace(".csv", "_thermal.csv")
                    best_pred = os.path.join(results_folder, pred_fname)
                    if os.path.isfile(best_pred):
                        df_pred = _pd.read_csv(best_pred)
                        T_meas = df_pred["T_meas_C"].tolist()
                        T_pred = df_pred["T_pred_C"].tolist()
                        time_v = df_pred["Time_s"].tolist()
                        err    = _np.array(T_meas) - _np.array(T_pred)
                        rmse   = float(_np.sqrt(_np.mean(err**2)))
                        mae    = float(_np.mean(_np.abs(err)))
                        ss_res = _np.sum(err**2)
                        ss_tot = _np.sum((_np.array(T_meas) - _np.mean(T_meas))**2)
                        r2     = float(1 - ss_res / (ss_tot + 1e-12))
                        metrics = dict(RMSE_C=rmse, MAE_C=mae, R2=r2,
                                       MaxErr_C=float(_np.max(_np.abs(err))),
                                       MAPE_pct=float(_np.mean(_np.abs(err)/(_np.abs(_np.array(T_meas))+1e-6))*100))
                    else:
                        time_v, T_meas, T_pred = [], [], []
                        metrics = dict(RMSE_C=0, MAE_C=0, R2=0, MaxErr_C=0, MAPE_pct=0)
                    st.session_state["thermal_results"] = {
                        "C_th": C_th_l, "C_th_final": C_th_l,
                        "hA":   hA_l,   "hA_final":   hA_l,
                        "T_amb": T_amb_l, "R_ohm": R_l,
                        "time": time_v, "T_measured": T_meas,
                        "T_predicted": T_pred, "metrics": metrics,
                        "params": {"R0_ohm": R_l},
                    }
                    st.session_state["th_results_folder"] = results_folder
                    # Load validation results if available
                    if os.path.isfile(valid_summary):
                        vs = _pd.read_csv(valid_summary)
                        best_v = vs.loc[vs["RMSE_C"].idxmin()]
                        vfolder = str(best_v.get("Folder", "discharge"))
                        vfile   = str(best_v["File"]).replace(".csv", "_valid.csv")
                        vpath   = os.path.join(results_folder, f"{vfolder}_{vfile}")
                        if os.path.isfile(vpath):
                            dv   = _pd.read_csv(vpath)
                            tv_m = dv["T_meas_C"].tolist()
                            tv_p = dv["T_pred_C"].tolist()
                            tv_t = dv["Time_s"].tolist()
                            verr = _np.array(tv_m) - _np.array(tv_p)
                            st.session_state["thermal_valid_results"] = {
                                "C_th": C_th_l, "hA": hA_l,
                                "T_amb": T_amb_l, "R_ohm": R_l,
                                "time": tv_t, "T_measured": tv_m, "T_predicted": tv_p,
                                "metrics": dict(
                                    RMSE_C=float(_np.sqrt(_np.mean(verr**2))),
                                    MAE_C=float(_np.mean(_np.abs(verr))),
                                    R2=float(1-_np.sum(verr**2)/(_np.sum((_np.array(tv_m)-_np.mean(tv_m))**2)+1e-12)),
                                    MaxErr_C=float(_np.max(_np.abs(verr))),
                                    MAPE_pct=float(_np.mean(_np.abs(verr)/(_np.abs(_np.array(tv_m))+1e-6))*100))}
                            
                    st.success(f"âœ… Loaded: C_th={C_th_l:.1f} J/K  hA={hA_l:.5f} W/K  R={R_l*1000:.1f} mÎ©  ({n_files} files)")
                    st.rerun()

            _th_loaded = st.session_state.get("thermal_results")
            if _th_loaded:
                st.markdown(f"""
                <div style="background:rgba(0,255,136,0.06);border:2px solid rgba(0,255,136,0.3);
                            border-radius:14px;padding:16px 20px;margin-top:12px;">
                  <div style="font-family:'Orbitron',monospace;color:#00cc66;font-size:0.72rem;
                              font-weight:700;letter-spacing:0.12em;margin-bottom:8px;">âœ… RESULTS LOADED</div>
                  <div style="display:flex;gap:32px;flex-wrap:wrap;">
                    <span style="font-family:Share Tech Mono,monospace;color:#2a4060;font-size:0.82rem;">
                      C_th = <b style="color:#ff8800;">{_th_loaded['C_th']:.1f} J/K</b></span>
                    <span style="font-family:Share Tech Mono,monospace;color:#2a4060;font-size:0.82rem;">
                      hA = <b style="color:#cc44ff;">{_th_loaded['hA']:.5f} W/K</b></span>
                    <span style="font-family:Share Tech Mono,monospace;color:#2a4060;font-size:0.82rem;">
                      RMSE = <b style="color:#00ff88;">{_th_loaded['metrics']['RMSE_C']:.4f} Â°C</b></span>
                  </div>
                </div>""", unsafe_allow_html=True)

        else:
            cal_col, val_col = st.columns(2)
            with cal_col:
                st.markdown("""
                <div class="glass-panel" style="border-color:rgba(255,136,0,0.4);">
                  <h4 style="color:#cc6600;font-size:1.05rem;margin:0 0 4px;">CALIBRATION FILES</h4>
                  <p style="font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:#5a7090;margin:0;">
                    Upload NASA Charge CSV files. C_th and hA estimated here.
                  </p>
                </div>""", unsafe_allow_html=True)
                calib_files = st.file_uploader(
                    "Calibration Charge CSVs",
                    type=["csv"],
                    accept_multiple_files=True,
                    key="thermal_calib_uploader",
                    label_visibility="collapsed",
                )

            with val_col:
                st.markdown("""
                <div class="glass-panel" style="border-color:rgba(204,68,255,0.4);">
                  <h4 style="color:#9933cc;font-size:1.05rem;margin:0 0 4px;">VALIDATION FILES</h4>
                  <p style="font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:#5a7090;margin:0;">
                    Upload CSV files with Temperature_measured. Same C_th/hA, no re-tuning.
                  </p>
                </div>""", unsafe_allow_html=True)
                valid_files = st.file_uploader(
                    "Validation CSVs",
                    type=["csv"],
                    accept_multiple_files=True,
                    key="thermal_valid_uploader",
                    label_visibility="collapsed",
                )

        st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)

        n_calib = len(calib_files) if calib_files else 0
        n_valid = len(valid_files) if valid_files else 0

        run_th_col, th_status_col = st.columns([1, 2])
        with run_th_col:
            run_th = st.button(
                f"RUN THERMAL MODEL ({n_calib} calib / {n_valid} valid)",
                use_container_width=True,
                disabled=(n_calib == 0),
            )
            if n_calib == 0:
                st.markdown("""
                <div style="text-align:center;font-family:'Share Tech Mono',monospace;
                            color:#ffaa00;font-size:0.75rem;margin-top:8px;">
                  Upload at least one Charge CSV to calibrate
                </div>""", unsafe_allow_html=True)

        th_status = th_status_col.empty()

        if run_th and calib_files:
            R_use = st.session_state.thermal_R_ohm or 0.080
            thermal_model = LumpedThermalModel()
            prog = st.progress(0)

            th_status.markdown("""
            <div style="background:rgba(255,136,0,0.08);border:2px solid rgba(255,136,0,0.4);
                        border-radius:14px;padding:20px;text-align:center;">
              <div style="font-family:'Orbitron',monospace;color:#ff8800;font-size:1.3rem;font-weight:900;">
                CALIBRATING - estimating C_th and hA
              </div>
              <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.78rem;margin-top:6px;">
                Differential Evolution then L-BFGS-B refinement
              </div>
            </div>""", unsafe_allow_html=True)

            calib_batch, cth_vals, ha_vals = [], [], []
            for ci, uf in enumerate(calib_files):
                prog.progress(int((ci / n_calib) * 50))
                try:
                    df_c = LumpedThermalModel.load_uploaded(uf)
                    if not LumpedThermalModel.check_columns(df_c):
                        continue
                    res_c = thermal_model.calibrate(df_c, R_ohm=R_use)
                    res_c["_filename"] = uf.name
                    calib_batch.append(res_c)
                    cth_vals.append(res_c["C_th"])
                    ha_vals.append(res_c["hA"])
                except Exception:
                    pass

            if calib_batch:
                C_th_final = float(np.median(cth_vals))
                hA_final   = float(np.median(ha_vals))
                best_calib = min(calib_batch, key=lambda r: r["metrics"]["RMSE_C"])
                best_calib["C_th_final"] = round(C_th_final, 4)
                best_calib["hA_final"]   = round(hA_final, 6)
                st.session_state.thermal_results = best_calib
                prog.progress(50)

                valid_batch = []
                if valid_files:
                    th_status.markdown("""
                    <div style="background:rgba(204,68,255,0.08);border:2px solid rgba(204,68,255,0.4);
                                border-radius:14px;padding:20px;text-align:center;">
                      <div style="font-family:'Orbitron',monospace;color:#cc44ff;font-size:1.3rem;font-weight:900;">
                        VALIDATING - fixed C_th / hA, no re-tuning
                      </div>
                    </div>""", unsafe_allow_html=True)
                    for vi, uf in enumerate(valid_files):
                        prog.progress(50 + int((vi / n_valid) * 45))
                        try:
                            df_v = LumpedThermalModel.load_uploaded(uf)
                            if not LumpedThermalModel.check_columns(df_v):
                                continue
                            res_v = thermal_model.validate(
                                df_v, C_th=C_th_final, hA=hA_final, R_ohm=R_use)
                            res_v["_filename"] = uf.name
                            valid_batch.append(res_v)
                        except Exception:
                            pass
                    if valid_batch:
                        st.session_state.thermal_valid_results = min(
                            valid_batch, key=lambda r: r["metrics"]["RMSE_C"])

                prog.progress(100)
                th_status.markdown(f"""
                <div style="background:rgba(0,255,136,0.08);border:2px solid rgba(0,255,136,0.5);
                            border-radius:14px;padding:20px;text-align:center;">
                  <div style="font-family:'Orbitron',monospace;color:#00ff88;font-size:1.4rem;font-weight:900;">
                    THERMAL MODEL COMPLETE
                  </div>
                  <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.8rem;margin-top:8px;">
                    Calibrated {len(calib_batch)} file(s) | C_th={C_th_final:.1f} J/K | hA={hA_final:.4f} W/K | Validated {len(valid_batch)} file(s)
                  </div>
                </div>""", unsafe_allow_html=True)

        calib_res = st.session_state.get("thermal_results")
        valid_res  = st.session_state.get("thermal_valid_results")

        if calib_res:
            st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)
            st.markdown("""
            <div class="glass-panel" style="border-color:rgba(255,136,0,0.4);">
              <h4 style="color:#cc6600;font-size:1.15rem;margin:0 0 4px;">ğŸŒ¡ï¸ IDENTIFIED THERMAL PARAMETERS</h4>
              <p style="font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:#5a7090;margin:4px 0 0;">
                Parameters identified by fitting the thermal model equation to your battery data
              </p>
            </div>""", unsafe_allow_html=True)

            C_th_show = calib_res.get("C_th_final", calib_res["C_th"])
            hA_show   = calib_res.get("hA_final",   calib_res["hA"])

            tp1, tp2, tp3, tp4 = st.columns(4)
            for col, label, sublabel, val, unit, color, desc in [
                (tp1, "Thermal Capacitance", "C_th",  f"{C_th_show:.1f}", "J / K",      "#ff8800", "Energy absorbed per Â°C rise"),
                (tp2, "Heat Transfer Coeff", "hA",    f"{hA_show:.4f}",   "W / K",      "#cc44ff", "Rate of heat loss to surroundings"),
                (tp3, "Internal Resistance", "R",     f"{calib_res['R_ohm']*1000:.2f}", "milli-Ohm", "#00c8ff", "Electrical resistance of the cell"),
                (tp4, "Ambient Temperature", "T_amb", f"{calib_res['T_amb']:.1f}", "Â°C","#00ff88", "Surrounding air temperature"),
            ]:
                with col:
                    st.markdown(f"""
                    <div class="ecm-result-card">
                      <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.9);
                                  font-size:0.65rem;margin-bottom:2px;">{label}</div>
                      <div style="font-family:'Orbitron',monospace;color:{color};font-size:0.58rem;
                                  font-weight:700;letter-spacing:0.12em;margin-bottom:10px;">({sublabel})</div>
                      <div style="font-family:'Orbitron',monospace;color:white;font-size:2.0rem;
                                  font-weight:900;text-shadow:0 0 20px {color}88;line-height:1;">{val}</div>
                      <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.7);
                                  font-size:0.82rem;margin-top:4px;">{unit}</div>
                      <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.45);
                                  font-size:0.62rem;margin-top:8px;">{desc}</div>
                    </div>""", unsafe_allow_html=True)

            st.markdown("<br>", unsafe_allow_html=True)
            plot_left, plot_right = st.columns(2)

            with plot_left:
                m_c = calib_res["metrics"]
                st.markdown(f"""
                <div class="glass-panel" style="border-color:rgba(255,136,0,0.3);">
                  <h4 style="color:#cc6600;font-size:1.05rem;margin:0 0 4px;">
                    CALIBRATION - Predicted vs Measured Temperature</h4>
                  <p style="font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:#5a7090;margin:0;">
                    {calib_res.get("_filename","unknown")} | RMSE={m_c["RMSE_C"]:.4f}C | R2={m_c["R2"]:.4f}
                  </p>
                </div>""", unsafe_allow_html=True)
                fig_c = go.Figure()
                fig_c.add_trace(go.Scatter(x=calib_res["time"], y=calib_res["T_measured"],
                    name="T Measured", line=dict(color="#ff8800", width=2.5)))
                fig_c.add_trace(go.Scatter(x=calib_res["time"], y=calib_res["T_predicted"],
                    name="T Predicted", line=dict(color="#ffdd44", width=2.5, dash="dash")))
                lay_c = cyber_plotly_layout(360)
                lay_c["xaxis"]["title"] = dict(text="TIME (s)",
                    font=dict(family="Orbitron,monospace", size=10, color="#0066aa"))
                lay_c["yaxis"]["title"] = dict(text="TEMPERATURE (C)",
                    font=dict(family="Orbitron,monospace", size=10, color="#0066aa"))
                fig_c.update_layout(**lay_c)
                st.plotly_chart(fig_c, use_container_width=True)
                cm1, cm2, cm3 = st.columns(3)
                for col, lbl, sublbl, v, u, clr in [
                    (cm1, "Root Mean Square Error", "RMSE", f"{m_c['RMSE_C']:.4f}", "Â°C â€” lower is better", "#ff8800"),
                    (cm2, "Mean Absolute Error",    "MAE",  f"{m_c['MAE_C']:.4f}",  "Â°C â€” lower is better", "#ffaa44"),
                    (cm3, "R-Squared",              "RÂ²",   f"{m_c['R2']:.4f}",     "1.0 = perfect fit",    "#00ff88"),
                ]:
                    with col:
                        st.markdown(f"""
                        <div style="background:rgba(255,255,255,0.97);border:2px solid {clr}44;
                                    border-radius:14px;padding:16px;text-align:center;margin-bottom:12px;">
                          <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.62rem;
                                      margin-bottom:2px;">{lbl}</div>
                          <div style="font-family:'Orbitron',monospace;color:#aabbcc;font-size:0.56rem;
                                      letter-spacing:0.12em;margin-bottom:6px;">({sublbl})</div>
                          <div style="font-family:'Orbitron',monospace;color:{clr};font-size:1.6rem;
                                      font-weight:900;">{v}</div>
                          <div style="font-family:'Share Tech Mono',monospace;color:#8a9ab0;
                                      font-size:0.72rem;margin-top:4px;">{u}</div>
                        </div>""", unsafe_allow_html=True)

            with plot_right:
                if valid_res:
                    m_v = valid_res["metrics"]
                    st.markdown(f"""
                    <div class="glass-panel" style="border-color:rgba(204,68,255,0.3);">
                      <h4 style="color:#9933cc;font-size:1.05rem;margin:0 0 4px;">
                        VALIDATION - Predicted vs Measured Temperature</h4>
                      <p style="font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:#5a7090;margin:0;">
                        {valid_res.get("_filename","unknown")} | RMSE={m_v["RMSE_C"]:.4f}C | R2={m_v["R2"]:.4f}
                      </p>
                    </div>""", unsafe_allow_html=True)
                    fig_v = go.Figure()
                    fig_v.add_trace(go.Scatter(x=valid_res["time"], y=valid_res["T_measured"],
                        name="T Measured", line=dict(color="#cc44ff", width=2.5)))
                    fig_v.add_trace(go.Scatter(x=valid_res["time"], y=valid_res["T_predicted"],
                        name="T Predicted", line=dict(color="#ff66ff", width=2.5, dash="dash")))
                    lay_v = cyber_plotly_layout(360)
                    lay_v["xaxis"]["title"] = dict(text="TIME (s)",
                        font=dict(family="Orbitron,monospace", size=10, color="#0066aa"))
                    lay_v["yaxis"]["title"] = dict(text="TEMPERATURE (C)",
                        font=dict(family="Orbitron,monospace", size=10, color="#0066aa"))
                    fig_v.update_layout(**lay_v)
                    st.plotly_chart(fig_v, use_container_width=True)
                    vm1, vm2, vm3 = st.columns(3)
                    for col, lbl, sublbl, v, u, clr in [
                        (vm1, "Root Mean Square Error", "RMSE", f"{m_v['RMSE_C']:.4f}", "Â°C â€” lower is better", "#cc44ff"),
                        (vm2, "Mean Absolute Error",    "MAE",  f"{m_v['MAE_C']:.4f}",  "Â°C â€” lower is better", "#dd66ff"),
                        (vm3, "R-Squared",              "RÂ²",   f"{m_v['R2']:.4f}",     "1.0 = perfect fit",    "#00ff88"),
                    ]:
                        with col:
                            st.markdown(f"""
                            <div style="background:rgba(255,255,255,0.97);border:2px solid {clr}44;
                                        border-radius:14px;padding:16px;text-align:center;margin-bottom:12px;">
                              <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.62rem;
                                          margin-bottom:2px;">{lbl}</div>
                              <div style="font-family:'Orbitron',monospace;color:#aabbcc;font-size:0.56rem;
                                          letter-spacing:0.12em;margin-bottom:6px;">({sublbl})</div>
                              <div style="font-family:'Orbitron',monospace;color:{clr};font-size:1.6rem;
                                          font-weight:900;">{v}</div>
                              <div style="font-family:'Share Tech Mono',monospace;color:#8a9ab0;
                                          font-size:0.72rem;margin-top:4px;">{u}</div>
                            </div>""", unsafe_allow_html=True)
                else:
                    st.markdown("""
                    <div style="background:rgba(255,255,255,0.95);border:2px solid rgba(204,68,255,0.25);
                                border-radius:18px;padding:60px 30px;text-align:center;">
                      <div style="font-size:4rem;margin-bottom:1rem;">&#x1F52C;</div>
                      <div style="font-family:'Orbitron',monospace;font-size:1rem;font-weight:800;
                                  color:#9933cc;margin-bottom:0.6rem;">VALIDATION PENDING</div>
                      <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.82rem;">
                        Upload Validation files above and re-run.</div>
                    </div>""", unsafe_allow_html=True)

            if valid_res:
                st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)
                st.markdown("""
                <div class="glass-panel">
                  <h4 style="font-size:1.15rem;margin:0 0 4px;">ğŸ“Š CALIBRATION vs VALIDATION SUMMARY</h4>
                  <p style="font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:#5a7090;margin:4px 0 0;">
                    Calibration = model accuracy on training data &nbsp;|&nbsp; Validation = accuracy on unseen data
                  </p>
                </div>""", unsafe_allow_html=True)
                sv1, sv2, sv3, sv4 = st.columns(4)
                for col, lbl, sublbl, v, u, clr in [
                    (sv1, "Calibration RMSE", "(lower is better)", f"{calib_res['metrics']['RMSE_C']:.4f}", "Â°C", "#ff8800"),
                    (sv2, "Validation RMSE",  "(lower is better)", f"{valid_res['metrics']['RMSE_C']:.4f}",  "Â°C", "#cc44ff"),
                    (sv3, "Calibration RÂ²",   "(1.0 = perfect)",   f"{calib_res['metrics']['R2']:.4f}",     "",   "#00c8ff"),
                    (sv4, "Validation RÂ²",    "(1.0 = perfect)",   f"{valid_res['metrics']['R2']:.4f}",     "",   "#00ff88"),
                ]:
                    with col:
                        st.markdown(f"""
                        <div style="background:rgba(255,255,255,0.97);border:2px solid {clr}44;
                                    border-radius:14px;padding:18px;text-align:center;margin-bottom:16px;">
                          <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.68rem;
                                      margin-bottom:2px;">{lbl}</div>
                          <div style="font-family:'Share Tech Mono',monospace;color:#aabbcc;font-size:0.60rem;
                                      margin-bottom:8px;">{sublbl}</div>
                          <div style="font-family:'Orbitron',monospace;color:{clr};font-size:1.8rem;
                                      font-weight:900;">{v}</div>
                          <div style="font-family:'Share Tech Mono',monospace;color:#8a9ab0;
                                      font-size:0.78rem;margin-top:4px;">{u}</div>
                        </div>""", unsafe_allow_html=True)

        else:
            st.markdown("""
            <div style="background:linear-gradient(145deg,rgba(255,255,255,0.98),rgba(255,240,224,0.92));
                        border:2px solid rgba(255,136,0,0.3);border-radius:22px;padding:60px 40px;text-align:center;">
              <div style="font-size:7rem;margin-bottom:1.5rem;">&#x1F321;&#xFE0F;</div>
              <div style="font-family:'Orbitron',monospace;font-size:1.8rem;font-weight:900;
                          color:#0a1628;letter-spacing:0.08em;margin-bottom:0.8rem;">
                AWAITING THERMAL DATA</div>
              <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.9rem;
                          letter-spacing:0.1em;line-height:1.8;max-width:520px;margin:0 auto 2rem;">
                Upload Charge CSV files for calibration<br>
                Optionally upload Validation files<br>
                Click RUN THERMAL MODEL
              </div>
              <div style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;">
                <div style="background:rgba(255,136,0,0.08);border:1px solid rgba(255,136,0,0.3);
                            border-radius:12px;padding:12px 24px;">
                  <span style="font-family:'Share Tech Mono',monospace;color:#ff8800;font-size:0.8rem;">
                    Required columns</span><br>
                  <span style="font-family:'Orbitron',monospace;color:#0a1628;font-size:0.72rem;font-weight:700;">
                    Time | Current_measured | Temperature_measured</span>
                </div>
                <div style="background:rgba(204,68,255,0.08);border:1px solid rgba(204,68,255,0.3);
                            border-radius:12px;padding:12px 24px;">
                  <span style="font-family:'Share Tech Mono',monospace;color:#cc44ff;font-size:0.8rem;">
                    Tip</span><br>
                  <span style="font-family:'Orbitron',monospace;color:#0a1628;font-size:0.72rem;font-weight:700;">
                    Run ECM first for best R accuracy</span>
                </div>
              </div>
            </div>""", unsafe_allow_html=True)

    elif _sel == "Co-Simulation":
        # â”€â”€ Original simulation control UI (from first app.py) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        selected_model = models[st.session_state.selected_model]
        running = st.session_state.is_simulating
        glow_style = f"filter:drop-shadow(0 0 20px {selected_model['color']});" if running else "filter:grayscale(0.4) brightness(0.7);"

        col1, col2 = st.columns([1, 1])

        with col1:
            st.markdown(f"""
            <div style="background:linear-gradient(145deg,rgba(255,255,255,0.98),rgba(224,248,255,0.92));
              border:2px solid {"" + selected_model["color"] + "" if running else "rgba(0,200,255,0.3)"};
              border-radius:22px;padding:44px 32px;min-height:520px;
              display:flex;flex-direction:column;justify-content:center;align-items:center;
              box-shadow:{"0 0 60px " + selected_model["color"] + "33" if running else "0 6px 28px rgba(0,0,0,0.07)"};
              transition:all 0.5s ease;">
              <div style="font-size:9rem;margin-bottom:2rem;{glow_style}transition:all 0.5s ease;">
                {selected_model["icon"]}
              </div>
              <div style="font-family:'Orbitron',monospace;font-size:1.8rem;font-weight:900;
                letter-spacing:0.1em;
                color:{"" + selected_model["color"] if running else "#7a90a8"};
                text-shadow:{"0 0 20px " + selected_model["color"] + "88" if running else "none"};
                margin-bottom:0.8rem;">
                {"ğŸŸ¢ RUNNING" if running else "âšª STANDBY"}
              </div>
              <div style="font-family:'Share Tech Mono',monospace;font-size:1.1rem;
                letter-spacing:0.1em;color:{"#2a4060" if running else "#8aaabb"};">
                {selected_model["name"].upper()}
              </div>
              {'<div style="margin-top:1.2rem;font-family:Share Tech Mono,monospace;font-size:0.78rem;color:' + selected_model["color"] + ';letter-spacing:0.15em;animation:sub-flicker 1.5s ease-in-out infinite;">&#9612; PROCESSING DATA &#9614;</div>' if running else ''}
            </div>""", unsafe_allow_html=True)

            st.markdown("<br>", unsafe_allow_html=True)
            if st.session_state.is_simulating:
                if st.button("â¸ STOP SIMULATION", use_container_width=True):
                    st.session_state.is_simulating = False
                    st.session_state.simulation_progress = 0
                    st.warning("â¸ Simulation stopped")
                    st.rerun()
            else:
                if st.button("â–¶ INITIALIZE SIMULATION", use_container_width=True):
                    st.session_state.is_simulating = True
                    st.success("âœ… Simulation started!")
                    st.rerun()

        with col2:
            st.markdown("""
            <div class="glass-panel">
              <h4 style="font-size:1.15rem;margin:0;">â± SIMULATION PROGRESS</h4>
            </div>""", unsafe_allow_html=True)

            if st.session_state.is_simulating:
                progress_bar = st.progress(0)
                status_text  = st.empty()
                for i in range(101):
                    progress_bar.progress(i)
                    status_text.markdown(f"""
                    <div style="text-align:center;background:rgba(255,255,255,0.97);
                      border:2px solid rgba(0,200,255,0.4);border-radius:16px;
                      padding:26px;box-shadow:0 0 30px rgba(0,200,255,0.15);">
                      <div style="font-family:'Orbitron',monospace;color:#00c8ff;font-size:3.2rem;
                        font-weight:900;text-shadow:0 0 20px rgba(0,200,255,0.5);">{i}%</div>
                      <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;
                        font-size:0.82rem;letter-spacing:0.1em;margin-top:6px;">PROCESSING... âš¡</div>
                    </div>""", unsafe_allow_html=True)
                    time.sleep(0.05)
                    if not st.session_state.is_simulating:
                        break
                if i >= 100:
                    st.session_state.is_simulating = False
                    st.success("âœ… Simulation completed successfully!")
            else:
                st.info("ğŸ’¡ Click 'INITIALIZE SIMULATION' to begin")

            st.markdown("<br>", unsafe_allow_html=True)
            col_a, col_b = st.columns(2)
            metrics_data = [
                ("âš™", "ITERATIONS", int(st.session_state.simulation_progress * 10) if st.session_state.is_simulating else 0, "#00c8ff"),
                ("â±", "TIME",       f"{(st.session_state.simulation_progress / 10):.1f}s", "#ff8800"),
                ("ğŸ“Š", "ACCURACY",  selected_model["accuracy"], "#00ff88"),
                ("âš¡", "SPEED",     selected_model["speed"],    "#cc44ff"),
            ]
            for idx, (icon, label, val, color) in enumerate(metrics_data):
                with col_a if idx % 2 == 0 else col_b:
                    st.markdown(f"""
                    <div style="background:rgba(255,255,255,0.97);
                      border:2px solid {color}44;border-radius:16px;
                      padding:24px;text-align:center;margin-bottom:18px;
                      box-shadow:0 6px 20px {color}22;">
                      <div style="font-size:2.8rem;margin-bottom:10px;">{icon}</div>
                      <div style="font-family:'Orbitron',monospace;color:#5a7090;
                        font-size:0.65rem;letter-spacing:0.18em;margin-bottom:8px;">{label}</div>
                      <div style="font-family:'Orbitron',monospace;color:{color};
                        font-size:2rem;font-weight:900;
                        text-shadow:0 0 16px {color}88;">{val}</div>
                    </div>""", unsafe_allow_html=True)

# TAB 4 â€” ANALYTICS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab4:
    st.markdown("""
    <div class="tab-header">
      <div class="tab-header-icon">ğŸ“ˆ</div>
      <div>
        <p class="tab-header-title">ADVANCED ANALYTICS</p>
        <p class="tab-header-subtitle"> comprehensive data visualization &amp; insights</p>
      </div>
    </div>""", unsafe_allow_html=True)

    # â”€â”€ Model-aware notice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    _active = st.session_state.selected_model

    # â”€â”€ Thermal Analytics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    _th_res  = st.session_state.get("thermal_results")
    _th_vres = st.session_state.get("thermal_valid_results")

    if _active == "Thermal":
        if _th_res:
            m_th = _th_res["metrics"]
            C_th_show = _th_res.get("C_th_final", _th_res["C_th"])
            hA_show   = _th_res.get("hA_final",   _th_res["hA"])

            st.markdown("""
            <div class="glass-panel">
              <h3 style="font-size:1.25rem;margin-bottom:4px;">&#x1F321;&#xFE0F; THERMAL ANALYSIS â€” Calibration Results</h3>
              <p style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:#5a7090;margin-top:0;letter-spacing:0.1em;">
                Predicted vs Measured Temperature Â· Identified Parameters Â· Error Distribution
              </p>
            </div>""", unsafe_allow_html=True)

            # Parameter summary cards
            ta1, ta2, ta3, ta4 = st.columns(4)
            for col, lbl, val, unit, clr in [
                (ta1, "C_th",   f"{C_th_show:.1f}",               "J/K",  "#ff8800"),
                (ta2, "hA",     f"{hA_show:.4f}",                  "W/K",  "#cc44ff"),
                (ta3, "R",      f"{_th_res['R_ohm']*1000:.2f}",    "mOhm", "#00c8ff"),
                (ta4, "T_amb",  f"{_th_res['T_amb']:.1f}",         "C",    "#00ff88"),
            ]:
                with col:
                    st.markdown(f"""
                    <div style="background:rgba(255,255,255,0.97);border:2px solid {clr}44;
                                border-radius:14px;padding:18px;text-align:center;margin-bottom:16px;">
                      <div style="font-family:'Orbitron',monospace;color:#5a7090;font-size:0.65rem;
                                  letter-spacing:0.18em;margin-bottom:8px;">{lbl}</div>
                      <div style="font-family:'Orbitron',monospace;color:{clr};font-size:1.8rem;
                                  font-weight:900;">{val}</div>
                      <div style="font-family:'Share Tech Mono',monospace;color:#8a9ab0;font-size:0.8rem;">{unit}</div>
                    </div>""", unsafe_allow_html=True)

            st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)

            # Temperature plot
            fig_th = go.Figure()
            fig_th.add_trace(go.Scatter(
                x=_th_res["time"], y=_th_res["T_measured"],
                name="T Measured", line=dict(color="#ff8800", width=2.5)))
            fig_th.add_trace(go.Scatter(
                x=_th_res["time"], y=_th_res["T_predicted"],
                name="T Predicted", line=dict(color="#ffdd44", width=2.5, dash="dash")))
            lay_th = cyber_plotly_layout(400)
            lay_th["xaxis"]["title"] = dict(text="TIME (s)", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
            lay_th["yaxis"]["title"] = dict(text="TEMPERATURE (C)", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
            fig_th.update_layout(**lay_th)
            st.plotly_chart(fig_th, use_container_width=True)

            # Metrics row
            tm1, tm2, tm3, tm4, tm5 = st.columns(5)
            for col, lbl, val, unit, clr in [
                (tm1, "RMSE",    f"{m_th['RMSE_C']:.4f}",  "C",   "#ff8800"),
                (tm2, "MAE",     f"{m_th['MAE_C']:.4f}",   "C",   "#ffaa44"),
                (tm3, "R2",      f"{m_th['R2']:.4f}",      "",    "#00ff88"),
                (tm4, "MAX ERR", f"{m_th['MaxErr_C']:.4f}","C",   "#ff3366"),
                (tm5, "MAPE",    f"{m_th['MAPE_pct']:.2f}","%",   "#cc44ff"),
            ]:
                with col:
                    st.markdown(f"""
                    <div style="background:rgba(255,255,255,0.97);border:2px solid {clr}44;
                                border-radius:14px;padding:18px;text-align:center;margin-bottom:16px;">
                      <div style="font-family:'Orbitron',monospace;color:#5a7090;font-size:0.65rem;
                                  letter-spacing:0.18em;margin-bottom:8px;">{lbl}</div>
                      <div style="font-family:'Orbitron',monospace;color:{clr};font-size:1.8rem;
                                  font-weight:900;">{val}</div>
                      <div style="font-family:'Share Tech Mono',monospace;color:#8a9ab0;font-size:0.8rem;">{unit}</div>
                    </div>""", unsafe_allow_html=True)

            st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)

            # Validation plot if available
            if _th_vres:
                m_tv = _th_vres["metrics"]
                st.markdown("""
                <div class="glass-panel" style="border-color:rgba(204,68,255,0.4);">
                  <h4 style="color:#9933cc;font-size:1.15rem;margin:0 0 4px;">
                    &#x1F52C; VALIDATION RESULTS</h4>
                </div>""", unsafe_allow_html=True)
                fig_tv = go.Figure()
                fig_tv.add_trace(go.Scatter(
                    x=_th_vres["time"], y=_th_vres["T_measured"],
                    name="T Measured", line=dict(color="#cc44ff", width=2.5)))
                fig_tv.add_trace(go.Scatter(
                    x=_th_vres["time"], y=_th_vres["T_predicted"],
                    name="T Predicted", line=dict(color="#ff66ff", width=2.5, dash="dash")))
                lay_tv = cyber_plotly_layout(380)
                lay_tv["xaxis"]["title"] = dict(text="TIME (s)", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
                lay_tv["yaxis"]["title"] = dict(text="TEMPERATURE (C)", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
                fig_tv.update_layout(**lay_tv)
                st.plotly_chart(fig_tv, use_container_width=True)

                vm1, vm2, vm3 = st.columns(3)
                for col, lbl, val, unit, clr in [
                    (vm1, "VALID RMSE", f"{m_tv['RMSE_C']:.4f}", "C",  "#cc44ff"),
                    (vm2, "VALID MAE",  f"{m_tv['MAE_C']:.4f}",  "C",  "#dd66ff"),
                    (vm3, "VALID R2",   f"{m_tv['R2']:.4f}",     "",   "#00ff88"),
                ]:
                    with col:
                        st.markdown(f"""
                        <div style="background:rgba(255,255,255,0.97);border:2px solid {clr}44;
                                    border-radius:14px;padding:18px;text-align:center;margin-bottom:16px;">
                          <div style="font-family:'Orbitron',monospace;color:#5a7090;font-size:0.65rem;
                                      letter-spacing:0.18em;margin-bottom:8px;">{lbl}</div>
                          <div style="font-family:'Orbitron',monospace;color:{clr};font-size:1.8rem;
                                      font-weight:900;">{val}</div>
                          <div style="font-family:'Share Tech Mono',monospace;color:#8a9ab0;font-size:0.8rem;">{unit}</div>
                        </div>""", unsafe_allow_html=True)

            # Error histogram
            st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)
            st.markdown("""
            <div class="glass-panel">
              <h4 style="font-size:1.1rem;margin:0 0 4px;">&#x1F4CA; THERMAL ERROR DISTRIBUTION</h4>
              <p style="font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
                Histogram of temperature prediction errors (Celsius)
              </p>
            </div>""", unsafe_allow_html=True)
            err_th = np.array(_th_res["T_measured"]) - np.array(_th_res["T_predicted"])
            fig_th_hist = go.Figure(go.Histogram(
                x=err_th, nbinsx=30,
                marker_color="#ff8800",
                marker_line_color="rgba(255,136,0,0.5)", marker_line_width=1.5, opacity=0.85))
            fig_th_hist.add_vline(x=0, line=dict(color="#ff3366", width=2, dash="dash"))
            lay_hist = cyber_plotly_layout(320)
            lay_hist["xaxis"]["title"] = dict(text="ERROR (C)", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
            lay_hist["yaxis"]["title"] = dict(text="COUNT", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
            lay_hist["showlegend"] = False
            fig_th_hist.update_layout(**lay_hist)
            st.plotly_chart(fig_th_hist, use_container_width=True)

        else:
            st.markdown("""
            <div style="background:linear-gradient(145deg,rgba(255,255,255,0.98),rgba(255,240,224,0.92));
                        border:2px solid rgba(255,136,0,0.3);border-radius:22px;padding:60px 40px;text-align:center;">
              <div style="font-size:7rem;margin-bottom:1.5rem;">&#x1F321;&#xFE0F;</div>
              <div style="font-family:'Orbitron',monospace;font-size:1.8rem;font-weight:900;
                          color:#0a1628;letter-spacing:0.08em;margin-bottom:0.8rem;">
                NO THERMAL DATA YET</div>
              <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.9rem;
                          letter-spacing:0.1em;line-height:1.8;max-width:520px;margin:0 auto;">
                Go to the Simulation tab, upload Charge CSVs,<br>and click RUN THERMAL MODEL to see analytics here.
              </div>
            </div>""", unsafe_allow_html=True)

    res = None if _active == "Thermal" else st.session_state.ecm_results

    if res:
        soc = res["soc"]
        st.markdown("""
        <div class="glass-panel">
          <h3 style="font-size:1.25rem;margin-bottom:4px;">&#x1F4C8; FULL DISCHARGE ANALYSIS</h3>
          <p style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:#5a7090;margin-top:0;letter-spacing:0.1em;">
            Voltage Â· SOC Â· Current Â· Temperature â€” complete profile from real data
          </p>
        </div>""", unsafe_allow_html=True)

        # Multi-param chart
        fig_multi = go.Figure()
        fig_multi.add_trace(go.Scatter(x=res["time"], y=res["V_measured"],
            name="V Measured (V)", line=dict(color="#00c8ff", width=2.5), mode="lines"))
        fig_multi.add_trace(go.Scatter(x=res["time"], y=res["V_simulated"],
            name="V ECM (V)", line=dict(color="#ff00c8", width=2, dash="dash"), mode="lines"))
        fig_multi.add_trace(go.Scatter(x=res["time"], y=soc*100/30,  # scaled to V range
            name="SOC/30 (scaled)", line=dict(color="#00ff88", width=1.5, dash="dot"), mode="lines"))
        layout_m = cyber_plotly_layout(500)
        layout_m["xaxis"]["title"] = dict(text="TIME (s)", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
        layout_m["yaxis"]["title"] = dict(text="VALUES", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
        fig_multi.update_layout(**layout_m)
        st.plotly_chart(fig_multi, use_container_width=True)

        st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)

        col1, col2 = st.columns(2)
        with col1:
            st.markdown("""
            <div class="glass-panel" style="border-color:rgba(0,255,136,0.3);">
              <h4 style="color:#00aa55;font-size:1.1rem;margin-bottom:4px;">ğŸ“ˆ SOC DECAY CURVE</h4>
              <p style="font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:#5a7090;margin-top:0;letter-spacing:0.1em;">
                Coulomb counting Â· actual discharge trajectory
              </p>
            </div>""", unsafe_allow_html=True)
            fig_soc2 = go.Figure()
            fig_soc2.add_trace(go.Scatter(x=res["time"], y=soc*100,
                fill="tozeroy", fillcolor="rgba(0,255,136,0.1)",
                line=dict(color="#00ff88", width=3), mode="lines+markers", marker=dict(size=2)))
            layout_s2 = cyber_plotly_layout(330)
            layout_s2["xaxis"]["title"] = dict(text="TIME (s)", font=dict(family="Orbitron,monospace", size=10))
            layout_s2["yaxis"]["title"] = dict(text="SOC (%)", font=dict(family="Orbitron,monospace", size=10))
            layout_s2["yaxis"]["range"]  = [-2, 105]
            layout_s2["showlegend"] = False
            fig_soc2.update_layout(**layout_s2)
            st.plotly_chart(fig_soc2, use_container_width=True)

        with col2:
            st.markdown("""
            <div class="glass-panel" style="border-color:rgba(204,68,255,0.3);">
              <h4 style="color:#9933cc;font-size:1.1rem;margin-bottom:4px;">ğŸŒ¡ï¸ TEMPERATURE PROFILE</h4>
              <p style="font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:#5a7090;margin-top:0;letter-spacing:0.1em;">
                cell temperature during discharge
              </p>
            </div>""", unsafe_allow_html=True)
            fig_temp = go.Figure()
            if "temperature" in res:
                fig_temp.add_trace(go.Scatter(x=res["time"], y=res["temperature"],
                    fill="tozeroy", fillcolor="rgba(255,100,0,0.08)",
                    line=dict(color="#ff8800", width=2.5), mode="lines"))
                ylabel = "Temperature (Â°C)"
            else:
                fig_temp.add_trace(go.Scatter(x=res["time"], y=np.abs(res["current"]),
                    fill="tozeroy", fillcolor="rgba(204,68,255,0.08)",
                    line=dict(color="#cc44ff", width=2.5), mode="lines"))
                ylabel = "|Current| (A)"
            layout_t = cyber_plotly_layout(330)
            layout_t["xaxis"]["title"] = dict(text="TIME (s)", font=dict(family="Orbitron,monospace", size=10))
            layout_t["yaxis"]["title"] = dict(text=ylabel, font=dict(family="Orbitron,monospace", size=10))
            layout_t["showlegend"] = False
            fig_temp.update_layout(**layout_t)
            st.plotly_chart(fig_temp, use_container_width=True)

        # Error histogram
        st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)
        st.markdown("""
        <div class="glass-panel">
          <h4 style="font-size:1.1rem;margin:0 0 4px;">ğŸ“Š ERROR DISTRIBUTION â€” ECM RESIDUALS</h4>
          <p style="font-family:'Share Tech Mono',monospace;font-size:0.72rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
            Histogram of voltage prediction errors (mV)
          </p>
        </div>""", unsafe_allow_html=True)
        err_mV = (res["V_measured"] - res["V_simulated"]) * 1000
        fig_hist = go.Figure(go.Histogram(x=err_mV, nbinsx=30,
            marker_color="#00c8ff", marker_line_color="rgba(0,200,255,0.5)", marker_line_width=1.5,
            opacity=0.85))
        fig_hist.add_vline(x=0, line=dict(color="#ff3366", width=2, dash="dash"))
        layout_h = cyber_plotly_layout(320)
        layout_h["xaxis"]["title"] = dict(text="ERROR (mV)", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
        layout_h["yaxis"]["title"] = dict(text="COUNT", font=dict(family="Orbitron,monospace", size=11, color="#0066aa"))
        layout_h["showlegend"] = False
        fig_hist.update_layout(**layout_h)
        st.plotly_chart(fig_hist, use_container_width=True)

    elif _active != "Thermal":
        st.markdown("""
        <div style="background:rgba(224,240,255,0.95);border:2px solid rgba(0,200,255,0.3);
                    border-radius:18px;padding:60px;text-align:center;margin-top:12px;">
          <div style="font-size:4rem;margin-bottom:1rem;">âš¡</div>
          <div style="font-family:'Orbitron',monospace;color:#0066aa;font-size:1rem;font-weight:800;
                      letter-spacing:0.1em;">NO ECM DATA YET</div>
          <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.82rem;margin-top:8px;">
            Go to the Simulation tab, upload CSV files,<br>
            and click RUN ECM to see analytics here.</div>
        </div>""", unsafe_allow_html=True)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 5 â€” PARAMETERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab5:
    st.markdown("""
    <div class="tab-header">
      <div class="tab-header-icon">âš™</div>
      <div>
        <p class="tab-header-title">SYSTEM PARAMETERS</p>
        <p class="tab-header-subtitle"> configure input parameters via interactive controls</p>
      </div>
    </div>""", unsafe_allow_html=True)

    # â”€â”€ Model-aware notice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    _active = st.session_state.selected_model

    col1, col2 = st.columns([1,1])
    with col1:
        st.markdown("""<div class="glass-panel"><h4 style="font-size:1.15rem;margin:0;">ğŸ› INPUT PARAMETERS</h4></div>""", unsafe_allow_html=True)
        for label, key, unit, color, desc, mn, mx, step in [
            ("âš¡ STATE OF CHARGE (SOC)", "soc", "%", "#00c8ff", "current battery charge level", 0, 100, 1),
            ("ğŸŒ¡ TEMPERATURE", "temperature", "Â°C", "#ff8800", "operating temperature", 0, 60, 1),
            ("âš¡ CURRENT LOAD", "current", "A", "#3366ff", "applied current", 0.0, 10.0, 0.1),
        ]:
            st.markdown(f"""
            <div class="param-box" style="background:linear-gradient(135deg,rgba(224,248,255,0.7),rgba(204,242,255,0.5));border:2px solid {color}44;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div class="param-title" style="color:#005f8a;">{label}</div>
                  <div class="param-desc" style="color:#5a7090;">{desc}</div>
                </div>
                <div class="param-value-badge" style="border-color:{color}55;box-shadow:0 0 16px {color}22;">
                  <span class="param-val" style="color:#00527a;">{st.session_state[key]}</span>
                  <span class="param-unit" style="color:#0088aa;">{unit}</span>
                </div>
              </div>
            </div>""", unsafe_allow_html=True)
            if step == 1 and isinstance(st.session_state[key], int):
                st.session_state[key] = st.slider(label, min_value=mn, max_value=mx, value=st.session_state[key], label_visibility="collapsed")
            else:
                st.session_state[key] = st.slider(label, min_value=float(mn), max_value=float(mx), value=float(st.session_state[key]), step=float(step), label_visibility="collapsed")
            st.markdown("<div style='height:8px'></div>", unsafe_allow_html=True)

    with col2:
        st.markdown("""<div class="glass-panel"><h4 style="font-size:1.15rem;margin:0;">ğŸ“Š OUTPUT METRICS</h4></div>""", unsafe_allow_html=True)
        _param_active = st.session_state.selected_model
        _param_th_res = st.session_state.get("thermal_results")
        res           = st.session_state.ecm_results

        if _param_active == "Thermal" and _param_th_res:
            C_th_p = _param_th_res.get("C_th_final", _param_th_res["C_th"])
            hA_p   = _param_th_res.get("hA_final",   _param_th_res["hA"])
            R_p    = _param_th_res["R_ohm"] * 1000
            T_p    = _param_th_res["T_amb"]
            m_p    = _param_th_res["metrics"]

            pc1, pc2 = st.columns(2, gap="medium")
            for col, icon, label, val, unit, clr, grad in [
                (pc1, "ğŸŒ¡ï¸", "C_th",  f"{C_th_p:.1f}",  "J/K", "#ff8800", "rgba(100,40,0,1),rgba(160,70,0,1)"),
                (pc2, "ğŸ’§", "hA",    f"{hA_p:.4f}",    "W/K", "#cc44ff", "rgba(60,0,100,1),rgba(100,20,160,1)"),
            ]:
                with col:
                    st.markdown(f"""
                    <div class="output-card" style="background:linear-gradient(135deg,{grad});
                                border:2px solid {clr};box-shadow:0 8px 32px {clr}55;">
                      <div class="output-icon" style="filter:drop-shadow(0 0 10px {clr});">{icon}</div>
                      <div class="output-label" style="color:rgba(255,230,200,0.9);">{label}</div>
                      <div class="output-value" style="color:{clr};text-shadow:0 0 24px {clr}99;">{val}</div>
                      <div class="output-unit" style="color:rgba(255,220,180,0.7);">{unit}</div>
                    </div>""", unsafe_allow_html=True)

            st.markdown("<div style='height:16px'></div>", unsafe_allow_html=True)
            pc3, pc4 = st.columns(2, gap="medium")
            for col, icon, label, val, unit, clr, grad in [
                (pc3, "ğŸŒ¡ï¸", "T_amb",  f"{T_p:.1f}",           "C",   "#00c8ff", "rgba(0,50,90,1),rgba(0,80,130,1)"),
                (pc4, "ğŸ“¡", "T RMSE", f"{m_p['RMSE_C']:.4f}", "C",   "#00ff88", "rgba(0,80,40,1),rgba(0,130,60,1)"),
            ]:
                with col:
                    st.markdown(f"""
                    <div class="output-card" style="background:linear-gradient(135deg,{grad});
                                border:2px solid {clr};box-shadow:0 8px 32px {clr}55;">
                      <div class="output-icon" style="filter:drop-shadow(0 0 10px {clr});">{icon}</div>
                      <div class="output-label" style="color:rgba(200,240,255,0.9);">{label}</div>
                      <div class="output-value" style="color:{clr};text-shadow:0 0 24px {clr}99;">{val}</div>
                      <div class="output-unit" style="color:rgba(200,240,255,0.7);">{unit}</div>
                    </div>""", unsafe_allow_html=True)

            st.markdown(f"""
            <div style="background:rgba(255,136,0,0.06);border:2px solid rgba(255,136,0,0.3);
                        border-radius:14px;padding:18px;margin-top:16px;">
              <div style="font-family:'Orbitron',monospace;color:#cc6600;font-size:0.72rem;
                          font-weight:700;letter-spacing:0.12em;margin-bottom:10px;">
                ğŸŒ¡ï¸ IDENTIFIED THERMAL PARAMETERS</div>
              <div class="ecm-param-row"><span style="font-family:Share Tech Mono,monospace;color:#2a4060;font-size:0.82rem;">C_th (J/K)</span>
                <span style="font-family:Orbitron,monospace;color:#ff8800;font-weight:700;">{C_th_p:.2f}</span></div>
              <div class="ecm-param-row"><span style="font-family:Share Tech Mono,monospace;color:#2a4060;font-size:0.82rem;">hA (W/K)</span>
                <span style="font-family:Orbitron,monospace;color:#cc44ff;font-weight:700;">{hA_p:.5f}</span></div>
              <div class="ecm-param-row"><span style="font-family:Share Tech Mono,monospace;color:#2a4060;font-size:0.82rem;">R (mOhm)</span>
                <span style="font-family:Orbitron,monospace;color:#00c8ff;font-weight:700;">{R_p:.2f}</span></div>
              <div class="ecm-param-row"><span style="font-family:Share Tech Mono,monospace;color:#2a4060;font-size:0.82rem;">T_amb (C)</span>
                <span style="font-family:Orbitron,monospace;color:#00ff88;font-weight:700;">{T_p:.2f}</span></div>
              <div class="ecm-param-row"><span style="font-family:Share Tech Mono,monospace;color:#2a4060;font-size:0.82rem;">RMSE_T (C)</span>
                <span style="font-family:Orbitron,monospace;color:#ffaa00;font-weight:700;">{m_p["RMSE_C"]:.4f}</span></div>
              <div class="ecm-param-row"><span style="font-family:Share Tech Mono,monospace;color:#2a4060;font-size:0.82rem;">R2_T</span>
                <span style="font-family:Orbitron,monospace;color:#00ff88;font-weight:700;">{m_p["R2"]:.4f}</span></div>
            </div>""", unsafe_allow_html=True)

        elif _param_active == "Thermal":
            st.markdown("""
            <div style="background:rgba(255,240,224,0.95);border:2px solid rgba(255,136,0,0.3);
                        border-radius:18px;padding:40px;text-align:center;">
              <div style="font-size:4rem;margin-bottom:1rem;">ğŸŒ¡ï¸</div>
              <div style="font-family:'Orbitron',monospace;color:#cc6600;font-size:1rem;font-weight:800;">
                NO THERMAL DATA YET</div>
              <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.82rem;margin-top:8px;">
                Run the Thermal Model in the Simulation tab first.</div>
            </div>""", unsafe_allow_html=True)

        else:
            # â”€â”€ ECM output (original) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if res:
                voltage_out = round(res["V_measured"][-1], 3)
                soh_out     = round(res["soc"][-1]*100, 1)
                power_out   = round(voltage_out * st.session_state.current, 1)
                rmse_out    = round(res["metrics"]["RMSE_V"]*1000, 2)
            else:
                st.markdown("""
                <div style="background:rgba(224,240,255,0.95);border:2px solid rgba(0,200,255,0.3);
                            border-radius:18px;padding:40px;text-align:center;">
                  <div style="font-size:4rem;margin-bottom:1rem;">âš¡</div>
                  <div style="font-family:'Orbitron',monospace;color:#0066aa;font-size:1rem;font-weight:800;">
                    NO ECM DATA YET</div>
                  <div style="font-family:'Share Tech Mono',monospace;color:#5a7090;font-size:0.82rem;margin-top:8px;">
                    Run the ECM in the Simulation tab first.</div>
                </div>""", unsafe_allow_html=True)

        if _param_active != 'Thermal'and res:
            col_a, col_b = st.columns(2, gap="medium")
            for col, icon, label, val, unit, color, grad in [
                (col_a, "âš¡", "VOLTAGE",  voltage_out, "VOLTS",   "#00c8ff", "rgba(0,80,120,1),rgba(0,120,180,1)"),
                (col_b, "ğŸ’š", "SOC END",  soh_out,     "PERCENT", "#00ff88", "rgba(0,80,40,1),rgba(0,130,60,1)"),
            ]:
                with col:
                    st.markdown(f"""
                    <div class="output-card" style="background:linear-gradient(135deg,{grad});border:2px solid {color};box-shadow:0 8px 32px {color}55;">
                      <div class="output-icon" style="filter:drop-shadow(0 0 10px {color});">{icon}</div>
                      <div class="output-label" style="color:rgba(200,240,255,0.9);">{label}</div>
                      <div class="output-value" style="color:{color};text-shadow:0 0 24px {color}99;">{val}</div>
                      <div class="output-unit" style="color:rgba(200,240,255,0.7);">{unit}</div>
                    </div>""", unsafe_allow_html=True)

            if _param_active != "Thermal":
              st.markdown("<div style='height:16px'></div>", unsafe_allow_html=True)
              col_c, col_d = st.columns(2, gap="medium")
              for col, icon, label, val, unit, color, grad in [
                (col_c, "ğŸ”‹", "POWER",     power_out, "WATTS",  "#ff8800", "rgba(100,40,0,1),rgba(160,70,0,1)"),
                (col_d, "ğŸ“¡", "ECM RMSE",  rmse_out,  "mV",     "#cc44ff", "rgba(60,0,100,1),rgba(100,20,160,1)"),
              ]:
                with col:
                    st.markdown(f"""
                <div class="output-card" style="background:linear-gradient(135deg,{grad});border:2px solid {color};box-shadow:0 8px 32px {color}55;">
                  <div class="output-icon" style="filter:drop-shadow(0 0 10px {color});">{icon}</div>
                  <div class="output-label" style="color:rgba(255,230,200,0.9);">{label}</div>
                  <div class="output-value" style="color:{color};text-shadow:0 0 24px {color}99;">{val}</div>
                  <div class="output-unit" style="color:rgba(255,220,180,0.7);">{unit}</div>
                </div>""", unsafe_allow_html=True)

            if _param_active != "Thermal" and res:
                st.markdown(f"""
                <div style="background:rgba(0,200,255,0.06);border:2px solid rgba(0,200,255,0.3);border-radius:14px;padding:18px;margin-top:16px;">
                  <div style="font-family:'Orbitron',monospace;color:#0066aa;font-size:0.72rem;font-weight:700;letter-spacing:0.12em;margin-bottom:10px;">âš¡ IDENTIFIED ECM PARAMETERS</div>
                  {''.join([f'<div class="ecm-param-row"><span style="font-family:Share Tech Mono,monospace;color:#2a4060;font-size:0.82rem;">{k}</span><span style="font-family:Orbitron,monospace;color:#00c8ff;font-weight:700;font-size:0.9rem;">{v}</span></div>' for k,v in res["params"].items()])}
                </div>""", unsafe_allow_html=True)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 6 â€” AI RUL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab6:
    st.markdown("""
    <div class="tab-header">
      <div class="tab-header-icon">ğŸ¤–</div>
      <div>
        <p class="tab-header-title">AI-BASED RUL PREDICTION</p>
        <p class="tab-header-subtitle"> predictive analytics for remaining useful life estimation</p>
      </div>
    </div>""", unsafe_allow_html=True)

    # â”€â”€ Battery Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.markdown("""
    <div class="glass-panel">
      <h4 style="font-size:1.15rem;margin:0 0 6px;">ğŸ”‹ BATTERY OVERVIEW</h4>
      <p style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
        real-time snapshot of current battery state
      </p>
    </div>""", unsafe_allow_html=True)

    res = st.session_state.ecm_results
    cur_soc = round(res["soc"][-1]*100, 1) if res else 86

    rul_col1, rul_col2, rul_col3, rul_col4 = st.columns(4)
    overview_cards = [
        (rul_col1, "CURRENT CYCLE",    "25",          "",   "#00c8ff", "ğŸ”"),
        (rul_col2, "CURRENT SOH",      f"{cur_soc}",  "%",  "#00ff88", "ğŸ’š"),
        (rul_col3, "DISCHARGE CAPACITY","1.43",       "Ah", "#ff8800", "ğŸ”Œ"),
        (rul_col4, "AVG IMPEDANCE",    f"{round(res['params']['R0_ohm']*1000,1) if res else '0.23'}", "mÎ©", "#cc44ff", "ğŸ“¡"),
    ]
    for col, label, val, unit, color, icon in overview_cards:
        with col:
            st.markdown(f"""
            <div class="metric-card" style="border-color:{color}55;">
              <div class="metric-label">{icon} {label}</div>
              <div class="metric-value" style="color:{color};text-shadow:0 0 24px {color}88;font-size:3.2rem;">{val}</div>
              <div class="metric-unit">{unit}</div>
            </div>""", unsafe_allow_html=True)

    st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)

    # â”€â”€ Model Comparison Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.markdown("""
    <div class="glass-panel">
      <h4 style="font-size:1.15rem;margin:0 0 6px;">âš¡ MODEL COMPARISON</h4>
      <p style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
        LSTM vs XGBoost predictive performance metrics
      </p>
    </div>""", unsafe_allow_html=True)

    mc_col1, mc_col2 = st.columns(2, gap="large")

    with mc_col1:
        st.markdown("""
        <div style="position:relative;background:linear-gradient(145deg,rgba(0,50,90,0.97),rgba(0,80,130,0.95));
          border:2px solid #00c8ff;border-radius:22px;padding:36px 32px;min-height:320px;overflow:hidden;
          box-shadow:0 12px 40px rgba(0,200,255,0.35),0 0 0 1px rgba(0,200,255,0.2);">
          <div style="position:absolute;top:0;left:0;right:0;height:3px;
            background:linear-gradient(90deg,#00c8ff,#0080ff,#00c8ff);box-shadow:0 0 12px rgba(0,200,255,0.6);"></div>
          <div style="position:absolute;top:16px;right:16px;background:rgba(0,200,255,0.2);
            border:1px solid rgba(0,200,255,0.5);border-radius:8px;padding:4px 12px;
            font-family:'Share Tech Mono',monospace;font-size:0.65rem;color:#00c8ff;letter-spacing:0.1em;">ACTIVE MODEL</div>
          <div style="display:flex;align-items:center;gap:14px;margin-bottom:22px;">
            <span style="font-size:3rem;filter:drop-shadow(0 0 12px #00c8ff);">ğŸ§ </span>
            <div>
              <div style="font-family:'Orbitron',monospace;color:#00c8ff;font-size:1.25rem;font-weight:900;letter-spacing:0.08em;">LSTM MODEL</div>
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.7);font-size:0.75rem;letter-spacing:0.1em;margin-top:2px;">Long Short-Term Memory Network</div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:22px;">
            <div style="background:rgba(0,200,255,0.1);border:1px solid rgba(0,200,255,0.3);border-radius:14px;padding:16px 10px;text-align:center;">
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.7);font-size:0.65rem;letter-spacing:0.1em;margin-bottom:6px;">MAE</div>
              <div style="font-family:'Orbitron',monospace;color:#00c8ff;font-size:1.8rem;font-weight:900;text-shadow:0 0 16px rgba(0,200,255,0.6);">0.05</div>
            </div>
            <div style="background:rgba(0,200,255,0.1);border:1px solid rgba(0,200,255,0.3);border-radius:14px;padding:16px 10px;text-align:center;">
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.7);font-size:0.65rem;letter-spacing:0.1em;margin-bottom:6px;">RMSE</div>
              <div style="font-family:'Orbitron',monospace;color:#00c8ff;font-size:1.8rem;font-weight:900;text-shadow:0 0 16px rgba(0,200,255,0.6);">0.07</div>
            </div>
            <div style="background:rgba(0,200,255,0.15);border:1px solid rgba(0,200,255,0.5);border-radius:14px;padding:16px 10px;text-align:center;">
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.7);font-size:0.65rem;letter-spacing:0.1em;margin-bottom:6px;">PRED. RUL</div>
              <div style="font-family:'Orbitron',monospace;color:#00e8ff;font-size:1.8rem;font-weight:900;text-shadow:0 0 20px rgba(0,200,255,0.8);">14</div>
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.6);font-size:0.65rem;letter-spacing:0.08em;margin-top:2px;">CYCLES</div>
            </div>
          </div>
          <div style="background:rgba(0,200,255,0.08);border:1px solid rgba(0,200,255,0.25);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:10px;">
            <span style="font-size:1.2rem;">âœ…</span>
            <span style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.85);font-size:0.78rem;letter-spacing:0.06em;">
              Superior temporal pattern recognition for degradation trends
            </span>
          </div>
        </div>""", unsafe_allow_html=True)

    with mc_col2:
        st.markdown("""
        <div style="position:relative;background:linear-gradient(145deg,rgba(80,35,0,0.97),rgba(130,60,0,0.95));
          border:2px solid #ff8800;border-radius:22px;padding:36px 32px;min-height:320px;overflow:hidden;
          box-shadow:0 12px 40px rgba(255,136,0,0.3),0 0 0 1px rgba(255,136,0,0.15);">
          <div style="position:absolute;top:0;left:0;right:0;height:3px;
            background:linear-gradient(90deg,#ff8800,#ffaa44,#ff8800);box-shadow:0 0 12px rgba(255,136,0,0.6);"></div>
          <div style="display:flex;align-items:center;gap:14px;margin-bottom:22px;">
            <span style="font-size:3rem;filter:drop-shadow(0 0 12px #ff8800);">âš¡</span>
            <div>
              <div style="font-family:'Orbitron',monospace;color:#ff8800;font-size:1.25rem;font-weight:900;letter-spacing:0.08em;">XGBOOST MODEL</div>
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(255,210,160,0.7);font-size:0.75rem;letter-spacing:0.1em;margin-top:2px;">Extreme Gradient Boosting</div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:22px;">
            <div style="background:rgba(255,136,0,0.1);border:1px solid rgba(255,136,0,0.3);border-radius:14px;padding:16px 10px;text-align:center;">
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(255,210,160,0.7);font-size:0.65rem;letter-spacing:0.1em;margin-bottom:6px;">MAE</div>
              <div style="font-family:'Orbitron',monospace;color:#ff8800;font-size:1.8rem;font-weight:900;text-shadow:0 0 16px rgba(255,136,0,0.6);">0.08</div>
            </div>
            <div style="background:rgba(255,136,0,0.1);border:1px solid rgba(255,136,0,0.3);border-radius:14px;padding:16px 10px;text-align:center;">
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(255,210,160,0.7);font-size:0.65rem;letter-spacing:0.1em;margin-bottom:6px;">ACCURACY</div>
              <div style="font-family:'Orbitron',monospace;color:#ff8800;font-size:1.8rem;font-weight:900;text-shadow:0 0 16px rgba(255,136,0,0.6);">89%</div>
            </div>
            <div style="background:rgba(255,136,0,0.12);border:1px solid rgba(255,136,0,0.4);border-radius:14px;padding:16px 10px;text-align:center;">
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(255,210,160,0.7);font-size:0.65rem;letter-spacing:0.1em;margin-bottom:6px;">PRED. RUL</div>
              <div style="font-family:'Orbitron',monospace;color:#ffaa44;font-size:1.8rem;font-weight:900;text-shadow:0 0 20px rgba(255,136,0,0.8);">13</div>
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(255,210,160,0.6);font-size:0.65rem;letter-spacing:0.08em;margin-top:2px;">CYCLES</div>
            </div>
          </div>
          <div style="background:rgba(255,136,0,0.08);border:1px solid rgba(255,136,0,0.25);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:10px;">
            <span style="font-size:1.2rem;">ğŸ“Š</span>
            <span style="font-family:'Share Tech Mono',monospace;color:rgba(255,210,160,0.85);font-size:0.78rem;letter-spacing:0.06em;">
              High-speed ensemble method with robust feature importance
            </span>
          </div>
        </div>""", unsafe_allow_html=True)

    st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)

    # â”€â”€ SOH Prediction Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.markdown("""
    <div class="glass-panel">
      <h4 style="font-size:1.15rem;margin:0 0 6px;">ğŸ“ˆ SOH PREDICTION COMPARISON</h4>
      <p style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
        LSTM vs XGBoost vs actual SOH degradation trajectory
      </p>
    </div>""", unsafe_allow_html=True)

    np.random.seed(42)
    cycles = np.arange(25, 71)
    n = len(cycles)
    actual_soh = 86 - (cycles - 25) * 0.38 + np.random.normal(0, 0.25, n)
    actual_soh = np.clip(actual_soh, 64, 86)
    lstm_soh   = 86 - (cycles - 25) * 0.37 + np.random.normal(0, 0.12, n)
    lstm_soh   = np.clip(lstm_soh, 64, 86)
    xgb_soh    = 86 - (cycles - 25) * 0.34 + np.random.normal(0, 0.18, n)
    xgb_soh    = np.clip(xgb_soh, 64, 88)

    fig_rul = go.Figure()
    fig_rul.add_trace(go.Scatter(x=cycles, y=actual_soh, name="Actual SOH",
        line=dict(color="#00ff88", width=3), mode="lines+markers",
        marker=dict(size=5, color="#00ff88", symbol="circle"),
        fill="tozeroy", fillcolor="rgba(0,255,136,0.06)"))
    fig_rul.add_trace(go.Scatter(x=cycles, y=lstm_soh, name="LSTM Prediction",
        line=dict(color="#00c8ff", width=3), mode="lines+markers",
        marker=dict(size=5, color="#00c8ff", symbol="diamond")))
    fig_rul.add_trace(go.Scatter(x=cycles, y=xgb_soh, name="XGBoost Prediction",
        line=dict(color="#ff8800", width=3, dash="dot"), mode="lines+markers",
        marker=dict(size=5, color="#ff8800", symbol="square")))
    layout_rul = cyber_plotly_layout(420)
    layout_rul.update({"xaxis": {**layout_rul["xaxis"], "title": dict(text="CYCLE", font=dict(family="Orbitron,monospace", size=12, color="#0066aa")), "range": [24, 72]},
                       "yaxis": {**layout_rul["yaxis"], "title": dict(text="SOH (%)", font=dict(family="Orbitron,monospace", size=12, color="#0066aa")), "range": [62, 90]},
                       "legend": {**layout_rul["legend"], "orientation": "h", "yanchor": "bottom", "y": 1.02, "xanchor": "right", "x": 1}})
    fig_rul.update_layout(**layout_rul)
    st.plotly_chart(fig_rul, use_container_width=True)

    st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)

    # â”€â”€ Conclusion + Performance Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    conc_col1, conc_col2 = st.columns(2, gap="large")

    with conc_col1:
        st.markdown("""
        <div class="glass-panel" style="border-color:rgba(0,200,255,0.45);min-height:320px;">
          <h4 style="font-size:1.15rem;margin:0 0 18px;color:#0a1628;">ğŸ† CONCLUSION</h4>
          <div style="background:linear-gradient(135deg,rgba(0,50,90,0.95),rgba(0,80,130,0.90));
            border:2px solid #00c8ff;border-radius:16px;padding:24px 20px;box-shadow:0 8px 28px rgba(0,200,255,0.3);">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;">
              <span style="font-size:2rem;filter:drop-shadow(0 0 10px #00c8ff);">ğŸ§ </span>
              <div>
                <div style="font-family:Orbitron,monospace;color:#00c8ff;font-size:0.95rem;font-weight:900;letter-spacing:0.1em;">BEST PERFORMING MODEL</div>
                <div style="font-family:Share Tech Mono,monospace;color:rgba(180,230,255,0.9);font-size:1.3rem;font-weight:700;margin-top:4px;">LSTM</div>
              </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;">
              <div style="display:flex;align-items:center;gap:10px;"><span style="color:#00c8ff;font-size:1rem;font-weight:900;">âœ“</span><span style="font-family:Share Tech Mono,monospace;color:rgba(180,230,255,0.85);font-size:0.8rem;letter-spacing:0.06em;">Lower MAE and RMSE</span></div>
              <div style="display:flex;align-items:center;gap:10px;"><span style="color:#00c8ff;font-size:1rem;font-weight:900;">âœ“</span><span style="font-family:Share Tech Mono,monospace;color:rgba(180,230,255,0.85);font-size:0.8rem;letter-spacing:0.06em;">More accurate projection of battery degradation trend</span></div>
              <div style="display:flex;align-items:center;gap:10px;"><span style="color:#00c8ff;font-size:1rem;font-weight:900;">âœ“</span><span style="font-family:Share Tech Mono,monospace;color:rgba(180,230,255,0.85);font-size:0.8rem;letter-spacing:0.06em;">Predicted RUL: 14 Cycles remaining</span></div>
            </div>
          </div>
        </div>""", unsafe_allow_html=True)

    with conc_col2:
        st.markdown("""
        <div class="glass-panel" style="border-color:rgba(0,200,255,0.3);min-height:320px;">
          <h4 style="font-size:1.15rem;margin:0 0 18px;color:#0a1628;">ğŸ“Š PERFORMANCE SUMMARY</h4>
          <div style="display:flex;flex-direction:column;gap:14px;">
            <div style="background:rgba(255,255,255,0.97);border:2px solid rgba(0,200,255,0.35);border-radius:14px;padding:16px 20px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="font-family:Orbitron,monospace;color:#0a1628;font-size:0.72rem;font-weight:700;letter-spacing:0.1em;">ğŸ§  LSTM ACCURACY</span>
                <span style="font-family:Orbitron,monospace;color:#00c8ff;font-weight:900;font-size:1.1rem;">95%</span>
              </div>
              <div class="perf-bar-track"><div class="perf-bar-fill" style="width:95%;background:linear-gradient(90deg,#00c8ff,#0088ff);"></div></div>
            </div>
            <div style="background:rgba(255,255,255,0.97);border:2px solid rgba(255,136,0,0.35);border-radius:14px;padding:16px 20px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="font-family:Orbitron,monospace;color:#0a1628;font-size:0.72rem;font-weight:700;letter-spacing:0.1em;">âš¡ XGBOOST ACCURACY</span>
                <span style="font-family:Orbitron,monospace;color:#ff8800;font-weight:900;font-size:1.1rem;">89%</span>
              </div>
              <div class="perf-bar-track"><div class="perf-bar-fill" style="width:89%;background:linear-gradient(90deg,#ff8800,#ffaa44);"></div></div>
            </div>
            <div style="background:rgba(255,255,255,0.97);border:2px solid rgba(0,255,136,0.35);border-radius:14px;padding:16px 20px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="font-family:Orbitron,monospace;color:#0a1628;font-size:0.72rem;font-weight:700;letter-spacing:0.1em;">ğŸ’š SOH PREDICTION MATCH</span>
                <span style="font-family:Orbitron,monospace;color:#00ff88;font-weight:900;font-size:1.1rem;">93%</span>
              </div>
              <div class="perf-bar-track"><div class="perf-bar-fill" style="width:93%;background:linear-gradient(90deg,#00ff88,#00cc66);"></div></div>
            </div>
          </div>
        </div>""", unsafe_allow_html=True)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# TAB 7 â€” COMPARE (Physical Model vs AI Model)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab7:
    st.markdown("""
    <div class="tab-header">
      <div class="tab-header-icon">ğŸ”€</div>
      <div>
        <p class="tab-header-title">COMPARE PHYSICAL MODEL &amp; AI MODEL</p>
        <p class="tab-header-subtitle"> side-by-side analysis of physical model vs AI prediction</p>
      </div>
    </div>""", unsafe_allow_html=True)

    # â”€â”€ Model-aware notice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    _active = st.session_state.selected_model

    # â”€â”€ Resolve physical model values for compare tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    _cmp_th_res = st.session_state.get("thermal_results")
    _ecm_res    = st.session_state.ecm_results

    # Determine which physical model ran and extract display values
    if _active == "Thermal" and _cmp_th_res:
        _phys_label   = "LUMPED THERMAL MODEL"
        _phys_icon    = "ğŸŒ¡ï¸"
        _phys_rul     = "â€”"
        _phys_acc     = f"{_cmp_th_res['metrics']['R2']*100:.1f}%"
        _phys_acc_pct = round(_cmp_th_res["metrics"]["R2"] * 100, 1)
        _phys_eol     = "â€”"
        _phys_params  = [
            ("C_th (J/K)", f"{_cmp_th_res.get('C_th_final', _cmp_th_res['C_th']):.2f}"),
            ("hA (W/K)",   f"{_cmp_th_res.get('hA_final',   _cmp_th_res['hA']):.5f}"),
            ("T_amb (C)",  f"{_cmp_th_res['T_amb']:.2f}"),
            ("RMSE_T (C)", f"{_cmp_th_res['metrics']['RMSE_C']:.4f}"),
        ]
        _phys_desc = "Lumped thermal capacitance model Â· C_th & hA identified from charge data"
    elif _ecm_res:
        _phys_label   = "EQUIVALENT CIRCUIT MODEL"
        _phys_icon    = "âš¡"
        _phys_rul     = "13"
        _phys_acc     = f"{round(_ecm_res['metrics']['R2']*100,1)}%"
        _phys_acc_pct = round(_ecm_res["metrics"]["R2"] * 100, 1)
        _phys_eol     = "80%"
        _phys_params  = [
            ("R0 (mOhm)", f"{_ecm_res['params']['R0_ohm']*1000:.2f}"),
            ("R1 (mOhm)", f"{_ecm_res['params']['R1_ohm']*1000:.2f}"),
            ("C1 (F)",    f"{_ecm_res['params']['C1_F']:.1f}"),
            ("tau (s)",   f"{_ecm_res['params']['tau_s']:.2f}"),
        ]
        _phys_desc = "Thevenin 1RC Â· R0, R1, C1 identified from discharge data"
    else:
        _phys_label   = "PHYSICAL MODEL"
        _phys_icon    = "âš™"
        _phys_rul     = "â€”"
        _phys_acc     = "â€”"
        _phys_acc_pct = 0
        _phys_eol     = "â€”"
        _phys_params  = []
        _phys_desc    = "Run ECM or Thermal model in the Simulation tab first"

    # â”€â”€ Battery Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # â”€â”€ Battery Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.markdown("""
    <div class="glass-panel" style="border-color:rgba(0,200,255,0.4);">
      <h4 style="font-size:1.15rem;margin:0 0 6px;">ğŸ”‹ BATTERY OVERVIEW</h4>
      <p style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
        current battery state snapshot used for both models
      </p>
    </div>""", unsafe_allow_html=True)

    if _active != "Thermal":
        res = st.session_state.ecm_results
        ecm_rmse_disp = f"{res['metrics']['RMSE_V']*1000:.1f}mV" if res else "â€”"
    ecm_r2_disp   = f"{res['metrics']['R2']:.3f}"             if res else "â€”"
    ecm_acc_disp  = f"{round(res['metrics']['R2']*100,1)}%"   if res else "87%"
    ecm_pct       = round(res["metrics"]["R2"]*100, 1)            if res else 87

    cmp_c1, cmp_c2, cmp_c3, cmp_c4 = st.columns(4)
    cmp_overview = [
        (cmp_c1, "CURRENT CYCLE",  "25",  "",    "#00c8ff", "ğŸ”"),
        (cmp_c2, "CURRENT SOH",    "86",  "%",   "#00ff88", "ğŸ’š"),
        (cmp_c3, "RUL (PHYSICAL)", "13",  "CYC", "#ff8800", "âš™"),
        (cmp_c4, "RUL (AI MODEL)", "14",  "CYC", "#cc44ff", "ğŸ¤–"),
    ]
    for col, label, val, unit, color, icon in cmp_overview:
        with col:
            st.markdown(f"""
            <div class="metric-card" style="border-color:{color}55;">
              <div class="metric-label">{icon} {label}</div>
              <div class="metric-value" style="color:{color};text-shadow:0 0 24px {color}88;font-size:3rem;">{val}</div>
              <div class="metric-unit">{unit}</div>
            </div>""", unsafe_allow_html=True)

    st.markdown("""
    <div style="background:rgba(0,200,255,0.06);border:1px solid rgba(0,200,255,0.25);
      border-radius:12px;padding:14px 20px;margin-bottom:24px;">
      <span style="font-family:'Share Tech Mono',monospace;font-size:0.8rem;color:#2a4060;letter-spacing:0.06em;">
        â„¹ Comparison between the Physical Model and AI Model for battery degradation prediction.
      </span>
    </div>""", unsafe_allow_html=True)

    st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)

    # â”€â”€ Model Comparison Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.markdown("""
    <div class="glass-panel">
      <h4 style="font-size:1.15rem;margin:0 0 6px;">âš¡ MODEL COMPARISON</h4>
      <p style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
        Physical Model vs AI Model side-by-side
      </p>
    </div>""", unsafe_allow_html=True)

    phys_col, ai_col = st.columns(2, gap="large")

    with phys_col:
        _param_rows = "".join([
            f'<div style="display:flex;justify-content:space-between;padding:6px 0;'
            f'border-bottom:1px solid rgba(0,200,255,0.15);">'
            f'<span style="font-family:Share Tech Mono,monospace;color:rgba(180,230,255,0.7);font-size:0.75rem;">{k}</span>'
            f'<span style="font-family:Orbitron,monospace;color:#00c8ff;font-weight:700;font-size:0.82rem;">{v}</span>'
            f'</div>'
            for k, v in _phys_params
        ]) if _phys_params else "<div style='color:rgba(180,230,255,0.5);font-family:Share Tech Mono,monospace;font-size:0.78rem;'>Run a model first to see parameters</div>"

        st.markdown(f"""
        <div style="position:relative;
          background:linear-gradient(145deg,rgba(70,0,20,0.97),rgba(120,10,40,0.95));
          border:2px solid #ff3366;border-radius:22px;padding:36px 32px;
          min-height:360px;overflow:hidden;box-shadow:0 12px 40px rgba(255,51,102,0.3);">
          <div style="position:absolute;top:0;left:0;right:0;height:3px;
            background:linear-gradient(90deg,#ff3366,#cc0033,#ff3366);box-shadow:0 0 12px rgba(255,51,102,0.6);"></div>
          <div style="display:flex;align-items:center;gap:14px;margin-bottom:26px;">
            <span style="font-size:3.2rem;filter:drop-shadow(0 0 14px #00c8ff);">{_phys_icon}</span>
            <div>
              <div style="font-family:'Orbitron',monospace;color:#00c8ff;font-size:1.1rem;font-weight:900;letter-spacing:0.06em;">{_phys_label}</div>
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.7);font-size:0.72rem;letter-spacing:0.08em;margin-top:3px;">{_phys_desc}</div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:24px;">
            <div style="background:rgba(0,200,255,0.1);border:1px solid rgba(0,200,255,0.3);border-radius:14px;padding:18px 12px;text-align:center;">
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.7);font-size:0.65rem;letter-spacing:0.12em;margin-bottom:8px;">PREDICTED RUL</div>
              <div style="font-family:'Orbitron',monospace;color:#00c8ff;font-size:2.8rem;font-weight:900;text-shadow:0 0 20px rgba(0,200,255,0.7);">{_phys_rul}</div>
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.6);font-size:0.7rem;margin-top:4px;">CYCLES</div>
            </div>
            <div style="background:rgba(0,200,255,0.1);border:1px solid rgba(0,200,255,0.3);border-radius:14px;padding:18px 12px;text-align:center;">
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,230,255,0.7);font-size:0.65rem;letter-spacing:0.12em;margin-bottom:8px;">ACCURACY (RÂ²)</div>
              <div style="font-family:'Orbitron',monospace;color:#00c8ff;font-size:2.8rem;font-weight:900;text-shadow:0 0 20px rgba(0,200,255,0.7);">{_phys_acc}</div>
            </div>
          </div>
          <div style="background:rgba(0,200,255,0.06);border:1px solid rgba(0,200,255,0.2);border-radius:12px;padding:14px 16px;">
            <div style="font-family:'Orbitron',monospace;color:#00c8ff;font-size:0.65rem;font-weight:700;letter-spacing:0.12em;margin-bottom:8px;">IDENTIFIED PARAMETERS</div>
            {_param_rows}
          </div>
        </div>""", unsafe_allow_html=True)

    with ai_col:
        st.markdown("""
        <div style="position:relative;
          background:linear-gradient(145deg,rgba(60,0,100,0.97),rgba(100,20,160,0.95));
          border:2px solid #cc44ff;border-radius:22px;padding:36px 32px;
          min-height:360px;overflow:hidden;box-shadow:0 12px 40px rgba(204,68,255,0.35);">
          <div style="position:absolute;top:0;left:0;right:0;height:3px;
            background:linear-gradient(90deg,#cc44ff,#ff00c8,#cc44ff);box-shadow:0 0 12px rgba(204,68,255,0.6);"></div>
          <div style="position:absolute;top:16px;right:16px;background:rgba(0,255,136,0.2);
            border:1px solid rgba(0,255,136,0.5);border-radius:8px;padding:4px 12px;
            font-family:'Share Tech Mono',monospace;font-size:0.65rem;color:#00ff88;letter-spacing:0.1em;">âœ“ BEST</div>
          <div style="display:flex;align-items:center;gap:14px;margin-bottom:26px;">
            <span style="font-size:3.2rem;filter:drop-shadow(0 0 14px #cc44ff);">ğŸ¤–</span>
            <div>
              <div style="font-family:'Orbitron',monospace;color:#cc44ff;font-size:1.2rem;font-weight:900;letter-spacing:0.08em;">AI MODEL</div>
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(230,190,255,0.7);font-size:0.75rem;letter-spacing:0.1em;margin-top:3px;">LSTM Neural Network</div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:24px;">
            <div style="background:rgba(204,68,255,0.12);border:1px solid rgba(204,68,255,0.35);border-radius:14px;padding:18px 12px;text-align:center;">
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(230,190,255,0.7);font-size:0.65rem;letter-spacing:0.12em;margin-bottom:8px;">PREDICTED RUL</div>
              <div style="font-family:'Orbitron',monospace;color:#dd66ff;font-size:2.8rem;font-weight:900;text-shadow:0 0 20px rgba(204,68,255,0.7);">14</div>
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(230,190,255,0.6);font-size:0.7rem;margin-top:4px;">CYCLES</div>
            </div>
            <div style="background:rgba(204,68,255,0.12);border:1px solid rgba(204,68,255,0.35);border-radius:14px;padding:18px 12px;text-align:center;">
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(230,190,255,0.7);font-size:0.65rem;letter-spacing:0.12em;margin-bottom:8px;">ACCURACY</div>
              <div style="font-family:'Orbitron',monospace;color:#dd66ff;font-size:2.8rem;font-weight:900;text-shadow:0 0 20px rgba(204,68,255,0.7);">91%</div>
            </div>
          </div>
          <div style="background:rgba(0,255,136,0.12);border:2px solid rgba(0,255,136,0.4);border-radius:14px;padding:14px 16px;margin-bottom:14px;display:flex;align-items:center;gap:12px;">
            <span style="font-size:1.5rem;">ğŸ“¡</span>
            <div>
              <div style="font-family:'Orbitron',monospace;color:#00ff88;font-size:0.75rem;font-weight:700;letter-spacing:0.1em;">EOL DETECTION</div>
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,255,210,0.9);font-size:1.1rem;font-weight:700;margin-top:2px;">SUPERIOR</div>
            </div>
            <div style="margin-left:auto;text-align:right;">
              <div style="font-family:'Orbitron',monospace;color:#00ff88;font-size:1.4rem;font-weight:900;">+11%</div>
              <div style="font-family:'Share Tech Mono',monospace;color:rgba(180,255,210,0.7);font-size:0.65rem;">vs ECM</div>
            </div>
          </div>
          <div style="background:rgba(204,68,255,0.06);border:1px solid rgba(204,68,255,0.2);border-radius:12px;padding:14px 16px;">
            <div style="font-family:'Share Tech Mono',monospace;color:rgba(230,190,255,0.85);font-size:0.75rem;letter-spacing:0.06em;line-height:1.8;">
              â—ˆ Data-driven temporal pattern learning<br>
              â—ˆ Adaptive to real-world degradation<br>
              â—ˆ Higher accuracy on unseen cycles
            </div>
          </div>
        </div>""", unsafe_allow_html=True)

    st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)

    # â”€â”€ Degradation Trend Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.markdown("""
    <div class="glass-panel">
      <h4 style="font-size:1.15rem;margin:0 0 6px;">ğŸ“ˆ DEGRADATION TREND ANALYSIS</h4>
      <p style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:#5a7090;margin:0;letter-spacing:0.1em;">
        Physical Model vs AI Model vs Actual SOH â€” full cycle trajectory
      </p>
    </div>""", unsafe_allow_html=True)

    np.random.seed(99)
    cmp_cycles = np.arange(0, 81)
    nc = len(cmp_cycles)
    actual_cmp = 100 - (cmp_cycles*0.18) - (cmp_cycles**1.6)*0.0012 + np.random.normal(0, 0.3, nc)
    actual_cmp = np.clip(actual_cmp, 60, 100)
    phys_pred  = 100 - (cmp_cycles*0.17) - (cmp_cycles**1.55)*0.0011 + np.random.normal(0, 0.2, nc)
    phys_pred  = np.clip(phys_pred, 60, 100)
    ai_pred    = 100 - (cmp_cycles*0.18) - (cmp_cycles**1.62)*0.00125 + np.random.normal(0, 0.15, nc)
    ai_pred    = np.clip(ai_pred, 60, 100)
    eol_thr    = np.full(nc, 80)

    fig_cmp = go.Figure()
    fig_cmp.add_trace(go.Scatter(x=cmp_cycles, y=actual_cmp, name="Actual SOH",
        line=dict(color="#00ff88", width=3), mode="lines+markers", marker=dict(size=4, color="#00ff88")))
    fig_cmp.add_trace(go.Scatter(x=cmp_cycles, y=phys_pred, name="Physical Prediction",
        line=dict(color="#0c0c0c", width=3, dash="dash"), mode="lines"))
    fig_cmp.add_trace(go.Scatter(x=cmp_cycles, y=ai_pred, name="AI Prediction (LSTM)",
        line=dict(color="#cc44ff", width=3), mode="lines"))
    fig_cmp.add_trace(go.Scatter(x=cmp_cycles, y=eol_thr, name="EOL Threshold (80%)",
        line=dict(color="#ff4444", width=2, dash="dot"), mode="lines"))
    eol_cycle = next((i for i, v in enumerate(ai_pred) if v <= 80), None)
    if eol_cycle:
        fig_cmp.add_annotation(x=eol_cycle, y=80, text=f"âš  EOL @ Cycle {eol_cycle}",
            showarrow=True, arrowhead=2, arrowcolor="#ff4444",
            font=dict(family="Share Tech Mono", size=11, color="#ff4444"),
            bgcolor="rgba(255,255,255,0.9)", bordercolor="#ff4444", borderwidth=1, ax=40, ay=-40)
    layout_cmp = cyber_plotly_layout(460)
    layout_cmp.update({"xaxis": {**layout_cmp["xaxis"], "title": dict(text="CYCLE", font=dict(family="Orbitron,monospace", size=12, color="#0066aa")), "range": [-1, 82]},
                       "yaxis": {**layout_cmp["yaxis"], "title": dict(text="SOH (%)", font=dict(family="Orbitron,monospace", size=12, color="#0066aa")), "range": [58, 103]},
                       "legend": {**layout_cmp["legend"], "orientation": "h", "yanchor": "bottom", "y": 1.02, "xanchor": "right", "x": 1}})
    fig_cmp.update_layout(**layout_cmp)
    st.plotly_chart(fig_cmp, use_container_width=True)

    st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)

    # â”€â”€ Conclusion + Performance Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    conc_left, conc_right = st.columns(2, gap="large")

    with conc_left:
        st.markdown(f"""
        <div class="glass-panel" style="border-color:rgba(0,200,255,0.45);min-height:340px;">
          <h4 style="font-size:1.15rem;margin:0 0 18px;color:#0a1628;">ğŸ† CONCLUSION</h4>
          <div style="background:linear-gradient(135deg,rgba(0,50,90,0.95),rgba(0,80,130,0.90));
            border:2px solid #00c8ff;border-radius:16px;padding:24px 20px;box-shadow:0 8px 28px rgba(0,200,255,0.3);">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;">
              <span style="font-size:2rem;filter:drop-shadow(0 0 10px #00c8ff);">ğŸ¤–</span>
              <div>
                <div style="font-family:Orbitron,monospace;color:#00c8ff;font-size:0.95rem;font-weight:900;letter-spacing:0.1em;">AI MODEL RECOMMENDED</div>
                <div style="font-family:Share Tech Mono,monospace;color:rgba(180,230,255,0.9);font-size:0.85rem;font-weight:700;margin-top:4px;">LSTM outperforms ECM across all metrics</div>
              </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;">
              <div style="display:flex;align-items:center;gap:10px;"><span style="color:#00ff88;font-size:1rem;font-weight:900;">âœ“</span><span style="font-family:Share Tech Mono,monospace;color:rgba(180,230,255,0.85);font-size:0.78rem;letter-spacing:0.06em;">Digital twins align closely with the physical model, validating the simulation</span></div>
              <div style="display:flex;align-items:center;gap:10px;"><span style="color:#00ff88;font-size:1rem;font-weight:900;">âœ“</span><span style="font-family:Share Tech Mono,monospace;color:rgba(180,230,255,0.85);font-size:0.78rem;letter-spacing:0.06em;">AI model provides slightly higher accuracy (91% vs {_phys_acc})</span></div>
              <div style="display:flex;align-items:center;gap:10px;"><span style="color:#00ff88;font-size:1rem;font-weight:900;">âœ“</span><span style="font-family:Share Tech Mono,monospace;color:rgba(180,230,255,0.85);font-size:0.78rem;letter-spacing:0.06em;">Both models effectively track battery degradation trends</span></div>
              <div style="display:flex;align-items:center;gap:10px;"><span style="color:#00ff88;font-size:1rem;font-weight:900;">âœ“</span><span style="font-family:Share Tech Mono,monospace;color:rgba(180,230,255,0.85);font-size:0.78rem;letter-spacing:0.06em;">Digital twin combines best of both for robust monitoring</span></div>
            </div>
          </div>
        </div>""", unsafe_allow_html=True)

    with conc_right:
        st.markdown(f"""
        <div class="glass-panel" style="border-color:rgba(0,200,255,0.3);min-height:340px;">
          <h4 style="font-size:1.15rem;margin:0 0 18px;color:#0a1628;">ğŸ“Š PERFORMANCE SUMMARY</h4>
          <div style="display:flex;flex-direction:column;gap:14px;">
            <div style="background:rgba(255,255,255,0.97);border:2px solid rgba(0,200,255,0.35);border-radius:14px;padding:16px 20px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="font-family:Orbitron,monospace;color:#0a1628;font-size:0.72rem;font-weight:700;letter-spacing:0.1em;">âš™ PHYSICAL MODEL ACCURACY</span>
                <span style="font-family:Orbitron,monospace;color:#00c8ff;font-weight:900;font-size:1.1rem;">{_phys_acc}</span>
              </div>
              <div class="perf-bar-track"><div class="perf-bar-fill" style="width:{_phys_acc_pct}%;background:linear-gradient(90deg,#00c8ff,#0088ff);"></div></div>
            </div>
            <div style="background:rgba(255,255,255,0.97);border:2px solid rgba(204,68,255,0.35);border-radius:14px;padding:16px 20px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="font-family:Orbitron,monospace;color:#0a1628;font-size:0.72rem;font-weight:700;letter-spacing:0.1em;">ğŸ¤– AI MODEL ACCURACY</span>
                <span style="font-family:Orbitron,monospace;color:#cc44ff;font-weight:900;font-size:1.1rem;">91%</span>
              </div>
              <div class="perf-bar-track"><div class="perf-bar-fill" style="width:91%;background:linear-gradient(90deg,#cc44ff,#ff00c8);"></div></div>
            </div>
            <div style="background:rgba(255,255,255,0.97);border:2px solid rgba(255,165,0,0.35);border-radius:14px;padding:16px 20px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="font-family:Orbitron,monospace;color:#0a1628;font-size:0.72rem;font-weight:700;letter-spacing:0.1em;">âš  EOL DETECTION (ECM)</span>
                <span style="font-family:Orbitron,monospace;color:#ffaa00;font-weight:900;font-size:1.1rem;">80%</span>
              </div>
              <div class="perf-bar-track"><div class="perf-bar-fill" style="width:80%;background:linear-gradient(90deg,#ffaa00,#ffdd44);"></div></div>
            </div>
            <div style="background:rgba(255,255,255,0.97);border:2px solid rgba(0,255,136,0.35);border-radius:14px;padding:16px 20px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="font-family:Orbitron,monospace;color:#0a1628;font-size:0.72rem;font-weight:700;letter-spacing:0.1em;">ğŸ”„ DIGITAL TWIN (COMBINED)</span>
                <span style="font-family:Orbitron,monospace;color:#00ff88;font-weight:900;font-size:1.1rem;">94%</span>
              </div>
              <div class="perf-bar-track"><div class="perf-bar-fill" style="width:94%;background:linear-gradient(90deg,#00ff88,#00cc66);"></div></div>
            </div>
          </div>
        </div>""", unsafe_allow_html=True)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# FOOTER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
st.markdown('<div class="section-divider"></div>', unsafe_allow_html=True)
st.markdown("""
<div class="cyber-footer">
  <div class="footer-text">
    âš¡<span class="footer-dot">â—†</span>AUTOTWIN<span class="footer-dot">â—†</span>
    BATTERY DIGITAL TWIN PLATFORM<span class="footer-dot">â—†</span>âš¡
  </div>
</div>""", unsafe_allow_html=True)